---
phase: 04-ai-assisted-editing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/ui/views/code_editor/ai_panel/chat_panel.py
autonomous: true

must_haves:
  truths:
    - "User can see a chat panel with message history"
    - "User can type a message and send it"
    - "User sees streaming AI responses appear incrementally"
  artifacts:
    - path: "src/ui/views/code_editor/ai_panel/chat_panel.py"
      provides: "Chat panel UI component"
      contains: "class ChatPanel"
      min_lines: 100
  key_links:
    - from: "chat_panel.py"
      to: "AIGateway.chat_stream"
      via: "async streaming call"
      pattern: "chat_stream"
    - from: "chat_panel.py"
      to: "ChatState"
      via: "state listener"
      pattern: "state.add_listener"
---

<objective>
Create the ChatPanel UI component for AI code assistance. Users can ask questions about their code, see streaming responses, and select which AI provider to use.

Purpose: This is the primary user-facing AI interaction surface in the editor. Without it, users cannot chat with AI about their code.

Output: ChatPanel component ready for integration into CodeEditorView.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ai-assisted-editing/04-CONTEXT.md
@.planning/phases/04-ai-assisted-editing/04-RESEARCH.md
@.planning/phases/04-ai-assisted-editing/04-01-SUMMARY.md

# Services to use
@src/ui/views/code_editor/ai_panel/chat_state.py
@src/ai/gateway.py (AIGateway, AIMessage, chat_stream)
@src/ai/completions/token_counter.py

# UI patterns
@src/ui/theme.py (SkynetteTheme colors)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChatPanel UI component</name>
  <files>src/ui/views/code_editor/ai_panel/chat_panel.py</files>
  <action>
    Create ChatPanel component with message list and input field:

    ```python
    class ChatPanel(ft.Column):
        """AI chat panel for code assistance.

        Displays message history with streaming support, input field
        with send button, and provider selection dropdown.

        Layout:
        - Header with title and provider dropdown
        - Scrollable message list (auto-scroll to bottom)
        - Input row with TextField and send button

        Example:
            panel = ChatPanel(page=page, state=chat_state, gateway=gateway)
        """

        def __init__(
            self,
            page: ft.Page,
            state: ChatState,
            gateway: AIGateway,
            on_include_code: Callable[[], str] | None = None,  # Get selected code
        ):
            super().__init__()
            self._page_ref = page
            self.state = state
            self.gateway = gateway
            self._on_include_code = on_include_code

            self.expand = True
            self.spacing = 0

            # Register state listener
            self.state.add_listener(self._on_state_change)

        def build(self) -> None:
            # Build UI components...
    ```

    Component structure:
    1. **Header row**: "AI Assistant" title + provider dropdown (populated from gateway.providers)
    2. **Message list**: ft.ListView with auto_scroll=True, expand=True
       - Each message rendered as a ChatMessageBubble (user=right-aligned blue, assistant=left-aligned gray)
       - Include code context display if message has code_context
    3. **Input row**: TextField (shift_enter for newline, min_lines=1, max_lines=5) + "Include Code" button + Send IconButton

    Message bubble rendering:
    ```python
    def _build_message_bubble(self, msg: ChatMessage) -> ft.Control:
        is_user = msg.role == "user"
        return ft.Container(
            content=ft.Column([
                # Code context (if present)
                ft.Container(...) if msg.code_context else None,
                # Message text
                ft.Text(msg.content, selectable=True),
            ]),
            bgcolor=SkynetteTheme.ACCENT if is_user else SkynetteTheme.BG_TERTIARY,
            border_radius=8,
            padding=10,
            margin=ft.margin.only(
                left=50 if is_user else 0,
                right=0 if is_user else 50,
                top=5, bottom=5
            ),
        )
    ```

    Use SkynetteTheme colors throughout. Include docstrings.
  </action>
  <verify>
    ```bash
    python -c "
from src.ui.views.code_editor.ai_panel.chat_panel import ChatPanel
from src.ui.views.code_editor.ai_panel import ChatState
from src.ai.gateway import get_gateway
print('ChatPanel imports successfully')
"
    ```
  </verify>
  <done>ChatPanel renders message list with user/assistant bubbles, input field, provider dropdown, and include code button</done>
</task>

<task type="auto">
  <name>Task 2: Wire ChatPanel to AIGateway for streaming</name>
  <files>src/ui/views/code_editor/ai_panel/chat_panel.py</files>
  <action>
    Add streaming response handling to ChatPanel:

    1. **Send handler** (_on_send):
    ```python
    def _on_send(self, e: ft.ControlEvent = None) -> None:
        """Handle send button click or Enter key."""
        message = self._input_field.value.strip()
        if not message or self.state.is_streaming:
            return

        # Get code context if Include Code was clicked
        code_context = self._pending_code_context
        self._pending_code_context = None

        # Add user message
        self.state.add_message("user", message, code_context)

        # Clear input
        self._input_field.value = ""
        self._input_field.update()

        # Start streaming response
        asyncio.create_task(self._stream_response())
    ```

    2. **Stream response** (_stream_response):
    ```python
    async def _stream_response(self) -> None:
        """Stream AI response and update state."""
        self.state.set_streaming(True)

        # Build messages for API
        messages = self._build_api_messages()

        # Add empty assistant message for streaming
        self.state.add_message("assistant", "")

        try:
            provider = self.state.selected_provider
            async for chunk in self.gateway.chat_stream(messages, provider=provider):
                if chunk.content:
                    # Append to last message
                    current = self.state.messages[-1].content
                    self.state.update_last_message(current + chunk.content)

                if chunk.error:
                    self.state.update_last_message(
                        self.state.messages[-1].content + "\n\n[Response interrupted]"
                    )
                    break

        except Exception as e:
            self.state.update_last_message(f"Error: {str(e)}")

        finally:
            self.state.set_streaming(False)
    ```

    3. **Build API messages** (_build_api_messages):
    ```python
    def _build_api_messages(self) -> list[AIMessage]:
        """Convert ChatMessages to AIMessages for API."""
        api_messages = []

        # System message with context mode
        system_prompt = "You are a helpful coding assistant."
        api_messages.append(AIMessage(role="system", content=system_prompt))

        # Convert chat history
        for msg in self.state.messages:
            content = msg.content
            if msg.code_context:
                content = f"Code context:\n```\n{msg.code_context}\n```\n\n{content}"
            api_messages.append(AIMessage(role=msg.role, content=content))

        return api_messages
    ```

    4. **Include code handler**:
    ```python
    def _on_include_code(self, e: ft.ControlEvent) -> None:
        """Get code from editor and store for next message."""
        if self._on_include_code_callback:
            self._pending_code_context = self._on_include_code_callback()
            # Visual feedback
            self._include_code_btn.icon_color = SkynetteTheme.SUCCESS
            self._include_code_btn.update()
    ```

    5. **State change handler** to rebuild message list on changes.

    6. **Dispose method** to clean up listener.

    Update __init__.py exports to include ChatPanel.
  </action>
  <verify>
    ```bash
    python -c "
from src.ui.views.code_editor.ai_panel import ChatPanel, ChatState
from src.ai.gateway import AIGateway

# Verify methods exist
assert hasattr(ChatPanel, '_stream_response')
assert hasattr(ChatPanel, '_build_api_messages')
print('ChatPanel streaming methods verified')
"
    ```
  </verify>
  <done>ChatPanel streams responses from AIGateway, updates message list incrementally, handles errors gracefully</done>
</task>

</tasks>

<verification>
ChatPanel can be instantiated with required dependencies:

```bash
python -c "
from src.ui.views.code_editor.ai_panel import ChatPanel, ChatState
from src.ai.gateway import AIGateway

state = ChatState()
gateway = AIGateway()
# Can't fully test without Flet Page, but verify no import errors
print('ChatPanel ready for integration')
"
```
</verification>

<success_criteria>
1. ChatPanel renders header, message list, and input row
2. Messages display with user/assistant styling
3. Provider dropdown populated from gateway.providers
4. Streaming updates message content incrementally
5. Include Code button stores context for next message
6. Error handling shows errors in chat
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-assisted-editing/04-02-SUMMARY.md`
</output>
