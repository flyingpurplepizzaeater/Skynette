---
phase: 02-provider-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/ai/providers/grok.py
  - src/ai/providers/__init__.py
autonomous: true
user_setup:
  - service: xai-grok
    why: "Grok API access"
    env_vars:
      - name: XAI_API_KEY
        source: "xAI Console -> API Keys (https://console.x.ai)"

must_haves:
  truths:
    - "User can select Grok models from the model picker"
    - "User can send chat messages and receive Grok responses"
    - "User sees streaming responses appear incrementally"
    - "User receives clear error when API key is missing or invalid"
  artifacts:
    - path: "src/ai/providers/grok.py"
      provides: "Grok provider implementation"
      min_lines: 150
      exports: ["GrokProvider"]
    - path: "pyproject.toml"
      provides: "xai-sdk dependency"
      contains: "xai-sdk>=1.5.0"
  key_links:
    - from: "src/ai/providers/grok.py"
      to: "xai_sdk.Client"
      via: "SDK initialization"
      pattern: "xai_sdk.*Client"
    - from: "src/ai/providers/__init__.py"
      to: "GrokProvider"
      via: "export registration"
      pattern: "GrokProvider"
---

<objective>
Implement Grok provider using the official xai-sdk.

Purpose: Enable users to chat with xAI's Grok models (Grok-3, Grok-2, etc.) using the native gRPC-based SDK for optimal performance and access to agent tools API.

Output: Working GrokProvider class following the established BaseProvider pattern with streaming support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-provider-foundation/02-RESEARCH.md
@.planning/phases/02-provider-foundation/02-CONTEXT.md

# Reference implementations
@src/ai/providers/base.py
@src/ai/providers/anthropic.py
@src/ai/gateway.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add xai-sdk dependency</name>
  <files>pyproject.toml</files>
  <action>
Update the [project.optional-dependencies] ai section to add xai-sdk:

1. Add `"xai-sdk>=1.5.0"` to the ai dependencies list
2. Add comment: `# Grok (official xAI SDK)`

Note: Do NOT replace with OpenAI SDK + base_url hack. The native xai-sdk provides:
- Better streaming performance (gRPC vs HTTP)
- Access to agent tools API (future-proofing)
- Proper timeout handling for reasoning models
  </action>
  <verify>
Run `pip install "xai-sdk>=1.5.0"` to confirm package exists and installs.
Verify import works: `python -c "from xai_sdk import Client; print('OK')"`
  </verify>
  <done>pyproject.toml updated with xai-sdk>=1.5.0 in ai dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Implement GrokProvider</name>
  <files>src/ai/providers/grok.py</files>
  <action>
Create GrokProvider following the AnthropicProvider pattern. Key implementation details:

**Class structure:**
```python
class GrokProvider(BaseProvider):
    name = "grok"
    display_name = "xAI (Grok)"
    capabilities = {
        AICapability.TEXT_GENERATION,
        AICapability.CHAT,
        AICapability.IMAGE_ANALYSIS,
        AICapability.CODE_GENERATION,
    }

    MODELS = [
        {"id": "grok-3", "name": "Grok 3", "context": 131072},
        {"id": "grok-3-fast", "name": "Grok 3 Fast", "context": 131072},
        {"id": "grok-2", "name": "Grok 2", "context": 131072},
        {"id": "grok-2-vision", "name": "Grok 2 Vision", "context": 32768},
    ]
```

**SDK usage:**
- Import: `from xai_sdk import Client, AsyncClient`
- Message helpers: `from xai_sdk.chat import user, assistant, system`
- Client init: `Client(api_key=key, timeout=3600)` - use 3600s timeout for reasoning models
- Uses XAI_API_KEY env var by default

**Key patterns from research:**
1. Create chat: `chat = client.chat.create(model=self.model)`
2. Add messages: `chat.append(user("text"))`, `chat.append(system("text"))`, `chat.append(assistant("text"))`
3. Streaming: `for response, chunk in chat.stream():`
4. After stream, add response to history: `chat.append(response)`
5. Non-streaming: Use `chat()` instead of `stream()`

**PITFALL - Timeout on reasoning models:**
Default timeout may not be enough for complex prompts. Set `timeout=3600` (1 hour) to handle reasoning models like Grok-3.

**Message handling:**
- System messages: `chat.append(system(content))`
- User messages: `chat.append(user(content))`
- Assistant messages: `chat.append(assistant(content))`

**Error handling:**
- Catch gRPC deadline exceeded errors for timeout
- Return meaningful error messages for missing API key
- Log but don't crash on ImportError (package optional)
  </action>
  <verify>
Create a minimal test script:
```python
import asyncio
from src.ai.providers.grok import GrokProvider

async def test():
    p = GrokProvider()
    # Will fail without API key, but should not crash
    result = await p.initialize()
    print(f"Initialize without key: {result}")  # Should be False

asyncio.run(test())
```
  </verify>
  <done>GrokProvider class created with chat, generate, and chat_stream methods following BaseProvider contract</done>
</task>

<task type="auto">
  <name>Task 3: Register Grok provider</name>
  <files>src/ai/providers/__init__.py</files>
  <action>
Update the providers __init__.py to export GrokProvider:

1. Add import: `from src.ai.providers.grok import GrokProvider`
2. Add to `__all__` list: `"GrokProvider"`
3. In `initialize_default_providers()`, add Grok registration:

```python
# Try to initialize Grok provider
try:
    grok = GrokProvider()
    gateway.register_provider(grok, priority=4)
except Exception:
    pass  # Grok provider optional
```

Priority 4 places it after Local (1), Ollama (2), and Gemini (3) but before Demo (99).
  </action>
  <verify>
Run: `python -c "from src.ai.providers import GrokProvider; print('Import OK')"`
Run: `python -c "from src.ai.providers import initialize_default_providers; g = initialize_default_providers(); print([p for p in g.providers])"`
  </verify>
  <done>GrokProvider exported and registered in provider initialization</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Import chain works:**
   ```bash
   python -c "from src.ai.providers import GrokProvider; print(GrokProvider.name, GrokProvider.display_name)"
   ```
   Expected: `grok xAI (Grok)`

2. **Provider registration works:**
   ```bash
   python -c "from src.ai.providers import initialize_default_providers; g = initialize_default_providers(); print('grok' in g.providers)"
   ```
   Expected: `True`

3. **All existing tests still pass:**
   ```bash
   pytest tests/unit/test_ai_providers.py -v
   ```

4. **No ruff errors:**
   ```bash
   ruff check src/ai/providers/grok.py src/ai/providers/__init__.py
   ```
</verification>

<success_criteria>
- GrokProvider class exists with name="grok", display_name="xAI (Grok)"
- Provider uses xai-sdk (not OpenAI SDK hack)
- Provider implements initialize(), is_available(), generate(), chat(), chat_stream()
- Provider sets 3600s timeout for reasoning model support
- Provider returns False from initialize() when API key missing (no crash)
- Provider is registered in initialize_default_providers()
- All existing provider tests pass
- No ruff/lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-provider-foundation/02-02-SUMMARY.md`
</output>
