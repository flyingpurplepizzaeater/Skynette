---
phase: 02-provider-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/ai/providers/gemini.py
  - src/ai/providers/__init__.py
autonomous: true
user_setup:
  - service: google-gemini
    why: "Gemini API access"
    env_vars:
      - name: GOOGLE_API_KEY
        source: "Google AI Studio -> Get API Key (https://aistudio.google.com/apikey)"

must_haves:
  truths:
    - "User can select Gemini models from the model picker"
    - "User can send chat messages and receive Gemini responses"
    - "User sees streaming responses appear incrementally"
    - "User receives clear error when API key is missing or invalid"
  artifacts:
    - path: "src/ai/providers/gemini.py"
      provides: "Gemini provider implementation"
      min_lines: 150
      exports: ["GeminiProvider"]
    - path: "pyproject.toml"
      provides: "google-genai dependency"
      contains: "google-genai>=1.59.0"
  key_links:
    - from: "src/ai/providers/gemini.py"
      to: "google.genai.Client"
      via: "SDK initialization"
      pattern: "genai\\.Client"
    - from: "src/ai/providers/__init__.py"
      to: "GeminiProvider"
      via: "export registration"
      pattern: "GeminiProvider"
---

<objective>
Implement Gemini provider using the official google-genai SDK.

Purpose: Enable users to chat with Google's Gemini models (2.5 Flash, 2.0 Pro, etc.) using the modern SDK that replaces the deprecated google-generativeai package.

Output: Working GeminiProvider class following the established BaseProvider pattern with streaming support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-provider-foundation/02-RESEARCH.md
@.planning/phases/02-provider-foundation/02-CONTEXT.md

# Reference implementations
@src/ai/providers/base.py
@src/ai/providers/anthropic.py
@src/ai/gateway.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add google-genai dependency</name>
  <files>pyproject.toml</files>
  <action>
Update the [project.optional-dependencies] ai section to replace the deprecated google-generativeai with the modern google-genai SDK:

1. Replace `"google-generativeai>=0.5.0"` with `"google-genai>=1.59.0"` (NOT google-generativeai - that's deprecated)
2. Add comment: `# Gemini (official SDK, replaces deprecated google-generativeai)`

The google-genai SDK is the official replacement as of Nov 2025. Using the old package will result in missing features and eventual breakage.
  </action>
  <verify>
Run `pip install "google-genai>=1.59.0"` to confirm package exists and installs.
Verify import works: `python -c "from google import genai; print('OK')"`
  </verify>
  <done>pyproject.toml updated with google-genai>=1.59.0 in ai dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Implement GeminiProvider</name>
  <files>src/ai/providers/gemini.py</files>
  <action>
Create GeminiProvider following the AnthropicProvider pattern. Key implementation details:

**Class structure:**
```python
class GeminiProvider(BaseProvider):
    name = "gemini"
    display_name = "Google Gemini"
    capabilities = {
        AICapability.TEXT_GENERATION,
        AICapability.CHAT,
        AICapability.IMAGE_ANALYSIS,
        AICapability.CODE_GENERATION,
    }

    MODELS = [
        {"id": "gemini-2.5-flash", "name": "Gemini 2.5 Flash", "context": 1048576},
        {"id": "gemini-2.0-pro", "name": "Gemini 2.0 Pro", "context": 2097152},
        {"id": "gemini-1.5-pro", "name": "Gemini 1.5 Pro", "context": 2097152},
        {"id": "gemini-1.5-flash", "name": "Gemini 1.5 Flash", "context": 1048576},
    ]
```

**SDK usage (google-genai, NOT google-generativeai):**
- Import: `from google import genai` (NOT `import google.generativeai`)
- Client: `genai.Client(api_key=self.api_key)`
- Async client: `client.aio` for async operations
- Streaming: `await chat.send_message_stream(content)` NOT `stream=True` parameter

**Key patterns from research:**
1. Use `client.aio.models.*` for async (NOT `client.models.*` - that's sync)
2. Chat uses `client.aio.chats.create(model=self.model)` for conversation state
3. Stream with `async for chunk in await chat.send_message_stream(text):`
4. Each chunk has `.text` attribute for content
5. Clean up with `await aclient.aclose()` in cleanup method

**Message handling:**
- System messages: Pass as `system_instruction` parameter in chat creation
- User/Assistant: Standard role mapping

**Error handling:**
- Catch `google.genai.errors.APIError` for API errors
- Return meaningful error messages for missing API key
- Log but don't crash on ImportError (package optional)
  </action>
  <verify>
Create a minimal test script:
```python
import asyncio
from src.ai.providers.gemini import GeminiProvider

async def test():
    p = GeminiProvider()
    # Will fail without API key, but should not crash
    result = await p.initialize()
    print(f"Initialize without key: {result}")  # Should be False

asyncio.run(test())
```
  </verify>
  <done>GeminiProvider class created with chat, generate, and chat_stream methods following BaseProvider contract</done>
</task>

<task type="auto">
  <name>Task 3: Register Gemini provider</name>
  <files>src/ai/providers/__init__.py</files>
  <action>
Update the providers __init__.py to export GeminiProvider:

1. Add import: `from src.ai.providers.gemini import GeminiProvider`
2. Add to `__all__` list: `"GeminiProvider"`
3. In `initialize_default_providers()`, add Gemini registration:

```python
# Try to initialize Gemini provider
try:
    gemini = GeminiProvider()
    gateway.register_provider(gemini, priority=3)
except Exception:
    pass  # Gemini provider optional
```

Priority 3 places it after Local (1) and Ollama (2) but before Demo (99).
  </action>
  <verify>
Run: `python -c "from src.ai.providers import GeminiProvider; print('Import OK')"`
Run: `python -c "from src.ai.providers import initialize_default_providers; g = initialize_default_providers(); print([p for p in g.providers])"`
  </verify>
  <done>GeminiProvider exported and registered in provider initialization</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Import chain works:**
   ```bash
   python -c "from src.ai.providers import GeminiProvider; print(GeminiProvider.name, GeminiProvider.display_name)"
   ```
   Expected: `gemini Google Gemini`

2. **Provider registration works:**
   ```bash
   python -c "from src.ai.providers import initialize_default_providers; g = initialize_default_providers(); print('gemini' in g.providers)"
   ```
   Expected: `True`

3. **All existing tests still pass:**
   ```bash
   pytest tests/unit/test_ai_providers.py -v
   ```

4. **No ruff errors:**
   ```bash
   ruff check src/ai/providers/gemini.py src/ai/providers/__init__.py
   ```
</verification>

<success_criteria>
- GeminiProvider class exists with name="gemini", display_name="Google Gemini"
- Provider uses google-genai SDK (not deprecated google-generativeai)
- Provider implements initialize(), is_available(), generate(), chat(), chat_stream()
- Provider returns False from initialize() when API key missing (no crash)
- Provider is registered in initialize_default_providers()
- All existing provider tests pass
- No ruff/lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-provider-foundation/02-01-SUMMARY.md`
</output>
