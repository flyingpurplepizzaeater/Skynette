---
phase: 07
plan: 01
subsystem: agent-core
tags: [pydantic, state-machine, events, data-models]

dependency-graph:
  requires: []
  provides:
    - AgentState enum with 8 execution states
    - AgentSession model for tracking task execution
    - AgentPlan and PlanStep models for execution planning
    - AgentEvent model for lifecycle events
    - ToolDefinition, ToolCall, ToolResult for tool integration
  affects:
    - 07-02 (Tool Registry needs ToolDefinition)
    - 07-03 (Agent Loop needs all models)

tech-stack:
  added: []
  patterns:
    - "str, Enum for JSON-serializable enums"
    - "Pydantic BaseModel with Field(default_factory=...)"
    - "Literal type alias for event types"
    - "ConfigDict for Pydantic v2 configuration"

key-files:
  created:
    - src/agent/__init__.py
    - src/agent/models/__init__.py
    - src/agent/models/state.py
    - src/agent/models/plan.py
    - src/agent/models/event.py
    - src/agent/models/tool.py
  modified: []

decisions:
  - id: 07-01-01
    choice: "Use Literal type for AgentEventType instead of Enum"
    reason: "Better JSON serialization, cleaner type hints"

metrics:
  duration: ~15 minutes
  completed: 2026-01-20
---

# Phase 7 Plan 1: Agent Data Models Summary

Pydantic data models for agent state, plans, and events

## What Was Built

### State Models (`src/agent/models/state.py`)

**AgentState** - 8-state execution state machine:
- IDLE, PLANNING, EXECUTING, AWAITING_TOOL, AWAITING_APPROVAL, COMPLETED, FAILED, CANCELLED

**AgentSession** - Session tracking model:
- Fields: id, task, state, messages, variables, token_budget, tokens_used, created_at, updated_at, steps_completed
- Methods: can_continue(), remaining_tokens(), usage_percentage(), is_budget_warning()

### Plan Models (`src/agent/models/plan.py`)

**StepStatus** - 5-state step lifecycle:
- PENDING, RUNNING, COMPLETED, FAILED, SKIPPED

**PlanStep** - Individual execution step:
- Fields: id, description, tool_name, tool_params, dependencies, status, result, error

**AgentPlan** - Execution plan container:
- Fields: id, task, overview, steps, created_at
- Methods: get_next_step() (dependency-aware), is_complete(), has_failed()

### Event Models (`src/agent/models/event.py`)

**AgentEventType** - Literal type with 13 lifecycle events:
- state_change, plan_created, step_started, step_completed
- tool_called, tool_result, message, error
- budget_warning, budget_exceeded, iteration_limit, completed, cancelled

**AgentEvent** - Event model:
- Fields: type, data, timestamp, session_id
- Convenience constructors: state_change(), plan_created(), step_completed(), error()

### Tool Models (`src/agent/models/tool.py`)

**ToolDefinition** - Tool schema for LLM:
- Fields: name, description, parameters, category, is_destructive, requires_approval
- Methods: to_openai_format(), to_anthropic_format()

**ToolCall** - Tool invocation request:
- Fields: id, tool_name, parameters, created_at

**ToolResult** - Tool execution result:
- Fields: tool_call_id, success, data, error, duration_ms
- Convenience constructors: success_result(), failure_result()

## Commits

| Hash | Description |
|------|-------------|
| 586df52 | feat(07-01): create agent module structure and state models |
| f9807f6 | feat(07-01): create plan, step, and tool models |
| 3772210 | feat(07-01): create agent event types |
| 2f6e866 | fix(07-01): export all agent models from package |
| 640d00c | fix(07-01): add AgentEvent exports to agent package |

## Deviations from Plan

### Auto-added Functionality

**1. [Rule 2 - Missing Critical] Tool models added**
- **Found during:** Task 2 execution
- **Issue:** Tool data models (ToolDefinition, ToolCall, ToolResult) were auto-generated by external tooling
- **Benefit:** Provides foundation for tool system needed in 07-02
- **Files created:** src/agent/models/tool.py

**2. [External] Registry module scaffolding**
- **Found during:** Task 3 commit
- **Issue:** External automation created src/agent/registry/ with BaseTool and ToolRegistry
- **Note:** This is 07-02 scope but was auto-generated; not committed by this plan

## Key Patterns Established

1. **State enum pattern**: `class AgentState(str, Enum)` for JSON-serializable enums
2. **Pydantic defaults**: `Field(default_factory=lambda: ...)` for mutable/computed defaults
3. **Literal type alias**: Better than enum for event types that need clean JSON serialization
4. **Convenience constructors**: Class methods for common object creation patterns

## Verification Results

All success criteria met:
- [x] AgentState enum has all 8 states
- [x] AgentSession tracks task, state, messages, tokens with utility methods
- [x] AgentPlan contains steps with dependency resolution via get_next_step()
- [x] AgentEvent supports all lifecycle event types
- [x] All models use Pydantic BaseModel with proper Field defaults
- [x] Clean imports from src.agent package

```python
# All imports work
from src.agent import (
    AgentState, AgentSession,
    AgentPlan, PlanStep, StepStatus,
    AgentEvent, AgentEventType,
    ToolDefinition, ToolCall, ToolResult
)
```

## Next Phase Readiness

Ready for 07-02 (Tool Registry):
- ToolDefinition model provides schema for tool registration
- ToolCall/ToolResult models support tool execution tracking
- AgentSession ready to track tool invocations

Ready for 07-03 (Agent Loop):
- AgentState machine defines valid transitions
- AgentPlan with dependency-aware step retrieval
- AgentEvent supports all lifecycle notifications
