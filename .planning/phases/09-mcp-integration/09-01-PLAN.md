---
phase: 09-mcp-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agent/mcp/__init__.py
  - src/agent/mcp/models/__init__.py
  - src/agent/mcp/models/server.py
  - src/agent/mcp/models/trust.py
  - src/agent/mcp/storage/__init__.py
  - src/agent/mcp/storage/server_storage.py
  - src/agent/mcp/curated/__init__.py
  - src/agent/mcp/curated/servers.py
autonomous: true

must_haves:
  truths:
    - "MCPServerConfig can represent both stdio and HTTP server configurations"
    - "TrustLevel enum distinguishes built-in, verified, and user-added servers"
    - "Server configurations persist to SQLite and reload across app restarts"
    - "Curated servers are defined with correct MCP server commands"
  artifacts:
    - path: "src/agent/mcp/models/server.py"
      provides: "MCPServerConfig, MCPServerStatus, TransportType, ServerCategory"
      exports: ["MCPServerConfig", "MCPServerStatus", "TransportType", "ServerCategory"]
    - path: "src/agent/mcp/models/trust.py"
      provides: "TrustLevel enum, ToolApproval model"
      exports: ["TrustLevel", "ToolApproval"]
    - path: "src/agent/mcp/storage/server_storage.py"
      provides: "SQLite persistence for MCP server configs"
      exports: ["MCPServerStorage", "get_mcp_storage"]
    - path: "src/agent/mcp/curated/servers.py"
      provides: "Pre-defined vetted MCP server configurations"
      exports: ["CURATED_SERVERS", "get_curated_server"]
  key_links:
    - from: "src/agent/mcp/storage/server_storage.py"
      to: "src/agent/mcp/models/server.py"
      via: "imports MCPServerConfig for serialization"
      pattern: "from.*models.server import MCPServerConfig"
    - from: "src/agent/mcp/curated/servers.py"
      to: "src/agent/mcp/models/server.py"
      via: "creates MCPServerConfig instances"
      pattern: "MCPServerConfig\\("
---

<objective>
Create the foundational data models, storage layer, and curated server definitions for MCP integration.

Purpose: Establish the type-safe models and persistence that all MCP operations build upon. Per 09-CONTEXT.md, we need three trust tiers, category-based organization, and a curated list of vetted servers.

Output: Pydantic models for MCP configuration, SQLite storage for server persistence, and pre-defined configurations for vetted MCP servers (filesystem, browser, git, etc.).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mcp-integration/09-CONTEXT.md
@.planning/phases/09-mcp-integration/09-RESEARCH.md

# Existing patterns to follow
@src/agent/models/tool.py
@src/agent/registry/tool_registry.py
@src/data/storage.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP Configuration Models</name>
  <files>
    src/agent/mcp/__init__.py
    src/agent/mcp/models/__init__.py
    src/agent/mcp/models/server.py
    src/agent/mcp/models/trust.py
  </files>
  <action>
Create the MCP model directory structure and Pydantic models.

In `src/agent/mcp/models/trust.py`:
- `TrustLevel` enum with values: BUILTIN, VERIFIED, USER_ADDED (strings for JSON serialization)
- `ToolApproval` model with: id (str), server_id (str), tool_name (str), approved (bool), approved_at (Optional[datetime])

In `src/agent/mcp/models/server.py`:
- `TransportType` enum: STDIO, HTTP (SSE maps to HTTP per research)
- `ServerCategory` enum: BROWSER_TOOLS, FILE_TOOLS, DEV_TOOLS, DATA_TOOLS, PRODUCTIVITY, OTHER
- `MCPServerConfig` model with:
  - id: str (uuid default)
  - name: str
  - description: Optional[str]
  - transport: TransportType
  - command: Optional[str] (for stdio)
  - args: list[str] (default [])
  - env: dict[str, str] (default {})
  - url: Optional[str] (for HTTP)
  - headers: dict[str, str] (default {})
  - trust_level: TrustLevel (default USER_ADDED)
  - sandbox_enabled: bool (default True for USER_ADDED)
  - category: ServerCategory (default OTHER)
  - enabled: bool (default True)
  - created_at: datetime
  - last_connected: Optional[datetime]
  - last_error: Optional[str]
- `MCPServerStatus` model with:
  - server_id: str
  - connected: bool
  - connecting: bool
  - latency_ms: Optional[float]
  - tools_count: int
  - last_active: Optional[datetime]
  - error: Optional[str]

Use Literal types for enums where JSON serialization is critical (consistent with 07-01 decision). Follow existing pydantic patterns from src/agent/models/tool.py.
  </action>
  <verify>
```bash
cd C:/Users/karlt/OneDrive/Desktop/Claude/skynette-repo
python -c "from src.agent.mcp.models.server import MCPServerConfig, MCPServerStatus, TransportType, ServerCategory; from src.agent.mcp.models.trust import TrustLevel, ToolApproval; print('Models imported successfully')"
```
  </verify>
  <done>
MCPServerConfig can be instantiated with both stdio (command/args) and HTTP (url/headers) configurations. TrustLevel enum has three tiers. Models serialize to/from JSON correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP Server Storage</name>
  <files>
    src/agent/mcp/storage/__init__.py
    src/agent/mcp/storage/server_storage.py
  </files>
  <action>
Create SQLite storage for MCP server configurations, following the pattern from src/data/storage.py.

In `src/agent/mcp/storage/server_storage.py`:
- `MCPServerStorage` class with:
  - __init__(self, db_path: Optional[str] = None) - defaults to ~/.skynette/skynette.db (same DB as existing)
  - _init_tables() - creates mcp_servers and mcp_tool_approvals tables
  - save_server(config: MCPServerConfig) -> None - INSERT OR REPLACE
  - get_server(server_id: str) -> Optional[MCPServerConfig]
  - list_servers(enabled_only: bool = False) -> list[MCPServerConfig]
  - delete_server(server_id: str) -> bool
  - get_servers_by_category(category: ServerCategory) -> list[MCPServerConfig]
  - save_tool_approval(approval: ToolApproval) -> None
  - get_tool_approval(server_id: str, tool_name: str) -> Optional[ToolApproval]
  - is_tool_approved(server_id: str, tool_name: str) -> bool

Table schema for mcp_servers:
- id TEXT PRIMARY KEY
- name TEXT NOT NULL
- description TEXT
- transport TEXT NOT NULL
- command TEXT
- args TEXT (JSON array)
- env TEXT (JSON dict)
- url TEXT
- headers TEXT (JSON dict)
- trust_level TEXT NOT NULL
- sandbox_enabled INTEGER DEFAULT 1
- category TEXT
- enabled INTEGER DEFAULT 1
- created_at TEXT
- last_connected TEXT
- last_error TEXT

Table schema for mcp_tool_approvals:
- id TEXT PRIMARY KEY
- server_id TEXT NOT NULL
- tool_name TEXT NOT NULL
- approved INTEGER DEFAULT 0
- approved_at TEXT
- UNIQUE(server_id, tool_name)

Add module-level singleton accessor: get_mcp_storage() -> MCPServerStorage
  </action>
  <verify>
```bash
cd C:/Users/karlt/OneDrive/Desktop/Claude/skynette-repo
python -c "
from src.agent.mcp.storage.server_storage import MCPServerStorage, get_mcp_storage
from src.agent.mcp.models.server import MCPServerConfig, TransportType
import tempfile, os
db = tempfile.mktemp(suffix='.db')
storage = MCPServerStorage(db)
config = MCPServerConfig(name='test', transport=TransportType.STDIO, command='echo')
storage.save_server(config)
loaded = storage.get_server(config.id)
print(f'Saved and loaded: {loaded.name}')
os.unlink(db)
"
```
  </verify>
  <done>
Server configurations save to SQLite and reload correctly. Tool approvals persist. list_servers returns all or enabled-only servers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Curated Server Definitions</name>
  <files>
    src/agent/mcp/curated/__init__.py
    src/agent/mcp/curated/servers.py
  </files>
  <action>
Create pre-defined configurations for vetted MCP servers per 09-CONTEXT.md and 09-RESEARCH.md.

In `src/agent/mcp/curated/servers.py`:
- Define CURATED_SERVERS dict[str, MCPServerConfig] with verified servers:

1. "filesystem" server:
   - name: "Filesystem"
   - description: "Secure file operations (read, write, create, delete)"
   - transport: STDIO
   - command: "npx" (or "uvx" for Python version)
   - args: ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/allowed"]
   - trust_level: VERIFIED
   - sandbox_enabled: False (built-in has explicit path restrictions)
   - category: FILE_TOOLS

2. "browser" server:
   - name: "Browser"
   - description: "Playwright-based browser automation"
   - transport: STDIO
   - command: "npx"
   - args: ["-y", "@anthropic/browser-mcp"]
   - trust_level: VERIFIED
   - sandbox_enabled: False
   - category: BROWSER_TOOLS

3. "git" server:
   - name: "Git"
   - description: "Git repository operations"
   - transport: STDIO
   - command: "npx"
   - args: ["-y", "@modelcontextprotocol/server-git"]
   - trust_level: VERIFIED
   - sandbox_enabled: False
   - category: DEV_TOOLS

4. "fetch" server:
   - name: "Fetch"
   - description: "Web content fetching"
   - transport: STDIO
   - command: "npx"
   - args: ["-y", "@modelcontextprotocol/server-fetch"]
   - trust_level: VERIFIED
   - sandbox_enabled: False
   - category: DATA_TOOLS

5. "memory" server:
   - name: "Memory"
   - description: "Knowledge graph memory"
   - transport: STDIO
   - command: "npx"
   - args: ["-y", "@modelcontextprotocol/server-memory"]
   - trust_level: VERIFIED
   - sandbox_enabled: False
   - category: PRODUCTIVITY

Add helper functions:
- get_curated_server(server_key: str) -> Optional[MCPServerConfig] - returns a copy of the config
- list_curated_servers() -> list[MCPServerConfig] - returns copies of all curated configs
- is_curated_server(server_id: str) -> bool - checks if ID matches a curated server

Note: These servers use npx for easy installation. Users enable which ones they want (allowlist approach per 09-CONTEXT.md).
  </action>
  <verify>
```bash
cd C:/Users/karlt/OneDrive/Desktop/Claude/skynette-repo
python -c "
from src.agent.mcp.curated.servers import CURATED_SERVERS, get_curated_server, list_curated_servers
print(f'Curated servers: {list(CURATED_SERVERS.keys())}')
fs = get_curated_server('filesystem')
print(f'Filesystem: {fs.command} {fs.args}')
print(f'All curated: {len(list_curated_servers())} servers')
"
```
  </verify>
  <done>
Five vetted MCP servers are defined with correct commands and trust levels. get_curated_server returns copies (not references) to prevent mutation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Model imports work:
```bash
python -c "from src.agent.mcp import *; print('Package imports OK')"
```

2. Full round-trip test:
```bash
python -c "
from src.agent.mcp.storage.server_storage import MCPServerStorage
from src.agent.mcp.curated.servers import get_curated_server
import tempfile, os

db = tempfile.mktemp(suffix='.db')
storage = MCPServerStorage(db)

# Save a curated server
fs = get_curated_server('filesystem')
storage.save_server(fs)

# Verify load
loaded = storage.get_server(fs.id)
assert loaded.name == 'Filesystem'
assert loaded.trust_level.value == 'verified'

# List by category
from src.agent.mcp.models.server import ServerCategory
file_servers = storage.get_servers_by_category(ServerCategory.FILE_TOOLS)
assert len(file_servers) == 1

os.unlink(db)
print('All verification passed')
"
```
</verification>

<success_criteria>
- MCPServerConfig supports both stdio and HTTP transport configurations
- TrustLevel enum has BUILTIN, VERIFIED, USER_ADDED values
- Server configs save to SQLite and reload with all fields intact
- Five curated servers are defined with correct commands
- Storage singleton is accessible via get_mcp_storage()
</success_criteria>

<output>
After completion, create `.planning/phases/09-mcp-integration/09-01-SUMMARY.md`
</output>
