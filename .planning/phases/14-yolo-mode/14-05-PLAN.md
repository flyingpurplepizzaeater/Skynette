---
phase: 14-yolo-mode
plan: 05
type: execute
wave: 3
depends_on: ["14-01", "14-02", "14-03"]
files_modified:
  - src/agent/ui/autonomy_badge.py
  - src/agent/ui/autonomy_toggle.py
  - src/agent/ui/agent_panel.py
  - src/data/storage.py
autonomous: true

must_haves:
  truths:
    - "L5 badge displays with purple color (#8B5CF6)"
    - "Selecting L5 shows confirmation dialog (not instant)"
    - "Panel border turns purple when YOLO is active"
    - "'Don't warn again' preference persists in settings"
  artifacts:
    - path: "src/agent/ui/autonomy_badge.py"
      provides: "L5 purple styling"
      contains: "L5"
    - path: "src/agent/ui/autonomy_toggle.py"
      provides: "L5 confirmation flow"
      contains: "YoloConfirmationDialog"
    - path: "src/agent/ui/agent_panel.py"
      provides: "YOLO border styling"
      contains: "_update_yolo_styling"
  key_links:
    - from: "src/agent/ui/autonomy_toggle.py"
      to: "src/agent/ui/yolo_dialog.py"
      via: "dialog instantiation"
      pattern: "YoloConfirmationDialog"
---

<objective>
Update UI components for L5 YOLO mode with distinctive purple styling and confirmation flow.

Purpose: Visual indicators make YOLO mode clearly visible (badge + panel border). Confirmation dialog prevents accidental activation. "Don't warn again" preference reduces friction for power users.

Output: Badge shows L5 in purple, toggle shows dialog for L5, panel has purple border when YOLO active.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-yolo-mode/14-RESEARCH.md
@.planning/phases/14-yolo-mode/14-01-SUMMARY.md
@.planning/phases/14-yolo-mode/14-02-SUMMARY.md
@.planning/phases/14-yolo-mode/14-03-SUMMARY.md
@src/agent/ui/autonomy_badge.py
@src/agent/ui/autonomy_toggle.py
@src/agent/ui/agent_panel.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AutonomyBadge for L5</name>
  <files>src/agent/ui/autonomy_badge.py</files>
  <action>
    The badge should already work with L5 since it uses AUTONOMY_COLORS and AUTONOMY_LABELS dictionaries. Verify and ensure:

    1. Badge correctly reads L5 color from AUTONOMY_COLORS (purple #8B5CF6)
    2. Badge correctly reads L5 label from AUTONOMY_LABELS ("YOLO")
    3. update_level() method handles L5 properly

    If any hardcoded L1-L4 checks exist, update them to include L5.

    No changes needed if badge already uses the dictionaries dynamically.
  </action>
  <verify>
    Run: `python -c "from src.agent.ui.autonomy_badge import AutonomyBadge; badge = AutonomyBadge(level='L5'); print('L5 badge created')"`
    Expected: L5 badge created (no errors)
  </verify>
  <done>AutonomyBadge displays L5 with purple color and YOLO label</done>
</task>

<task type="auto">
  <name>Task 2: Add L5 confirmation flow to AutonomyToggle</name>
  <files>src/agent/ui/autonomy_toggle.py</files>
  <action>
    Update AutonomyToggle to show confirmation dialog when selecting L5:

    1. Add imports:
       ```python
       from src.agent.safety.sandbox import SandboxDetector
       from src.agent.ui.yolo_dialog import YoloConfirmationDialog
       from src.data.storage import get_storage
       ```

    2. Update `_build_menu_items()` to include L5:
       ```python
       for lvl in ["L1", "L2", "L3", "L4", "L5"]:
           # ... existing code ...
       ```

    3. Modify `_select_level()` to handle L5 specially:
       ```python
       def _select_level(self, level: str):
           """Handle level selection from menu."""
           if level == "L5" and self._level != "L5":
               # L5 requires confirmation dialog
               self._show_yolo_confirmation()
           elif level in ("L1", "L2", "L3", "L4", "L5") and level != self._level:
               # L1-L4 switch is instant (existing behavior)
               self._apply_level_change(level)

       def _apply_level_change(self, level: str):
           """Apply level change after confirmation (if needed)."""
           self._level = level  # type: ignore
           self._badge.update_level(level)  # type: ignore

           # Rebuild menu to update checkmarks
           self._popup.items = self._build_menu_items()
           self._popup.update()

           # Notify callback
           if self._on_level_change:
               self._on_level_change(level)  # type: ignore
       ```

    4. Add `_show_yolo_confirmation()` method:
       ```python
       def _show_yolo_confirmation(self):
           """Show confirmation dialog for YOLO mode."""
           # Check if user has opted out of warnings
           storage = get_storage()
           dont_warn = storage.get_setting("yolo_dont_warn_sandbox", "false") == "true"

           # Detect sandbox
           sandbox_info = SandboxDetector.detect()

           # Skip dialog if sandboxed or user opted out
           if sandbox_info.is_sandboxed or dont_warn:
               self._apply_level_change("L5")
               return

           # Show confirmation dialog
           dialog = YoloConfirmationDialog(
               is_sandboxed=sandbox_info.is_sandboxed,
               on_confirm=lambda: self._apply_level_change("L5"),
               on_dont_warn_again=self._set_dont_warn_again,
           )
           self.page.dialog = dialog
           dialog.open = True
           self.page.update()

       def _set_dont_warn_again(self):
           """Store preference to not warn about sandbox."""
           storage = get_storage()
           storage.set_setting("yolo_dont_warn_sandbox", "true")
       ```

    5. Update `set_level()` method to handle L5 without dialog (programmatic setting):
       ```python
       def set_level(self, level: AutonomyLevel):
           """Set the autonomy level programmatically (no dialog)."""
           if level != self._level:
               self._level = level
               self._badge.update_level(level)
               self._popup.items = self._build_menu_items()
               self._popup.update()
       ```
  </action>
  <verify>
    Run: `python -c "from src.agent.ui.autonomy_toggle import AutonomyToggle; t = AutonomyToggle(level='L2'); print(f'items={len(t._popup.items)}')" `
    Expected: items=5 (L1-L5)
  </verify>
  <done>AutonomyToggle shows confirmation dialog when selecting L5</done>
</task>

<task type="auto">
  <name>Task 3: Add YOLO styling to AgentPanel</name>
  <files>src/agent/ui/agent_panel.py</files>
  <action>
    Update AgentPanel to show purple border when YOLO is active:

    1. Add YOLO_COLOR constant at top:
       ```python
       YOLO_COLOR = "#8B5CF6"  # Purple for YOLO mode
       ```

    2. Add `_update_yolo_styling()` method:
       ```python
       def _update_yolo_styling(self, is_yolo: bool) -> None:
           """Update panel border styling for YOLO mode."""
           if not self._content_container:
               return

           if is_yolo:
               # Purple border and subtle background tint
               self._content_container.border = ft.border.only(
                   left=ft.BorderSide(2, YOLO_COLOR)
               )
               self._content_container.bgcolor = f"{YOLO_COLOR}08"  # Very subtle tint
           else:
               # Normal styling
               self._content_container.border = ft.border.only(
                   left=ft.BorderSide(1, Theme.BORDER)
               )
               self._content_container.bgcolor = Theme.BG_SECONDARY

           self._content_container.update()
       ```

    3. Update `_on_autonomy_level_change()` to update styling:
       ```python
       def _on_autonomy_level_change(self, level: AutonomyLevel) -> None:
           """Handle autonomy level change from toggle."""
           if self._project_path:
               svc = get_autonomy_service()
               svc.set_level(self._project_path, level)

           # Update YOLO styling
           self._update_yolo_styling(level == "L5")
       ```

    4. Update `set_project_path()` to check YOLO on project switch:
       ```python
       def set_project_path(self, project_path: str | None) -> None:
           """Set the current project path for autonomy settings."""
           self._project_path = project_path
           if self._autonomy_toggle:
               level = self._get_current_autonomy_level()
               self._autonomy_toggle.set_level(level)
               self._update_yolo_styling(level == "L5")
       ```
  </action>
  <verify>
    Run: `python -c "from src.agent.ui.agent_panel import AgentPanel, YOLO_COLOR; print(f'YOLO_COLOR={YOLO_COLOR}')" `
    Expected: YOLO_COLOR=#8B5CF6
  </verify>
  <done>AgentPanel displays purple border when YOLO mode is active</done>
</task>

</tasks>

<verification>
- AutonomyBadge displays L5 with purple color
- AutonomyToggle shows 5 menu items (L1-L5)
- Selecting L5 when not sandboxed shows YoloConfirmationDialog
- Selecting L5 when sandboxed or opted-out skips dialog
- "Don't warn again" sets yolo_dont_warn_sandbox setting
- AgentPanel border turns purple when L5 is active
- Normal styling restored when switching away from L5
</verification>

<success_criteria>
- L5 appears in toggle dropdown with purple dot
- L5 selection shows confirmation dialog (unless sandboxed/opted-out)
- Panel border changes to purple during YOLO mode
- Preferences persist across sessions
- Downgrade from L5 restores normal styling
</success_criteria>

<output>
After completion, create `.planning/phases/14-yolo-mode/14-05-SUMMARY.md`
</output>
