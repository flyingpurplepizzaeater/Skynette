---
phase: 14-yolo-mode
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/agent/safety/classification.py
  - src/agent/safety/autonomy.py
autonomous: true

must_haves:
  truths:
    - "L5 mode bypasses ALL approval requirements (true YOLO)"
    - "Allowlist/blocklist rules are NOT evaluated in L5 mode"
    - "L5 is session-only by default (not persisted to storage)"
  artifacts:
    - path: "src/agent/safety/classification.py"
      provides: "L5 bypass in classify()"
      contains: "L5"
    - path: "src/agent/safety/autonomy.py"
      provides: "Session-only L5 behavior"
      contains: "_session_yolo_projects"
  key_links:
    - from: "src/agent/safety/classification.py"
      to: "requires_approval=False"
      via: "L5 check before rules"
      pattern: "if.*level.*==.*L5.*requires_approval.*False"
---

<objective>
Implement L5 classification bypass and session-only behavior.

Purpose: L5 (YOLO) is TRUE autonomous mode - no approvals for any action. Session-only default ensures L5 resets when app closes, preventing accidental persistence across reboots.

Output: Classification bypasses approval for L5, autonomy service tracks L5 in-memory only by default.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-yolo-mode/14-RESEARCH.md
@.planning/phases/14-yolo-mode/14-01-SUMMARY.md
@src/agent/safety/classification.py
@src/agent/safety/autonomy.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add L5 bypass to ActionClassifier</name>
  <files>src/agent/safety/classification.py</files>
  <action>
    Modify `classify()` method to bypass ALL approval checks for L5 mode:

    1. In the `classify()` method, AFTER getting base risk and BEFORE checking rules:
       ```python
       # Get autonomy settings
       settings = self.autonomy_service.get_settings(project_path)

       # L5/YOLO: bypass ALL approval requirements - true autonomous mode
       if settings.level == "L5":
           return ActionClassification(
               risk_level=risk,
               reason=self._get_reason(tool_name, risk, parameters),
               requires_approval=False,  # NEVER requires approval in YOLO
               tool_name=tool_name,
               parameters=parameters,
           )
       ```

    2. This L5 check MUST happen BEFORE the `check_rules()` call - L5 bypasses everything including allowlist/blocklist

    3. The existing L1-L4 logic (rules check, threshold check) remains unchanged below the L5 early return

    Important: L5 is TRUE YOLO - if user wants restrictions, they shouldn't use L5. Blocklist rules are for L1-L4 only.
  </action>
  <verify>
    Run: `python -c "
from src.agent.safety.classification import ActionClassifier
from src.agent.safety.autonomy import get_autonomy_service, AutonomySettings

# Mock to return L5
class MockService:
    def get_settings(self, p): return AutonomySettings(level='L5')

classifier = ActionClassifier(autonomy_service=MockService())
result = classifier.classify('file_delete', {'path': '/critical'})
print(f'L5 file_delete requires_approval={result.requires_approval}')
"`
    Expected: L5 file_delete requires_approval=False
  </verify>
  <done>L5 mode bypasses all approval requirements including rules</done>
</task>

<task type="auto">
  <name>Task 2: Implement session-only L5 behavior</name>
  <files>src/agent/safety/autonomy.py</files>
  <action>
    Update AutonomyLevelService to track L5 in-memory only by default:

    1. Add `_session_yolo_projects` set to `__init__` if not already added in Plan 01:
       ```python
       self._session_yolo_projects: set[str] = set()  # In-memory L5 tracking
       ```

    2. Modify `set_level()` method with L5-specific handling:
       ```python
       def set_level(self, project_path: str, level: AutonomyLevel) -> None:
           normalized = str(Path(project_path).resolve())
           old_level = self._current_levels.get(normalized, self.get_default_level())

           if level == "L5":
               # Session-only by default: store in memory, DON'T persist
               self._session_yolo_projects.add(normalized)
               self._current_levels[normalized] = level
               # Notify callbacks if this is a change
               if old_level != "L5":
                   for callback in self._level_changed_callbacks:
                       # L5 is never a downgrade
                       callback(project_path, old_level, level, False)
               return  # Don't persist to storage

           # For L1-L4: remove from session YOLO if present
           self._session_yolo_projects.discard(normalized)
           self._current_levels[normalized] = level

           # Persist to storage
           storage = get_storage()
           storage.set_project_autonomy(normalized, level)

           # Notify callbacks on downgrade
           if self._is_downgrade(old_level, level):
               for callback in self._level_changed_callbacks:
                   callback(project_path, old_level, level, True)
       ```

    3. Update `get_settings()` to check in-memory L5 first:
       ```python
       # Check if L5 is active in session (takes precedence)
       if normalized in self._session_yolo_projects:
           return AutonomySettings(
               level="L5",
               allowlist_rules=[],  # L5 ignores rules anyway
               blocklist_rules=[],
           )
       ```

    4. Add `is_yolo_active()` helper method:
       ```python
       def is_yolo_active(self, project_path: str | None = None) -> bool:
           """Check if YOLO mode is active for project."""
           if project_path is None:
               return False
           normalized = str(Path(project_path).resolve())
           return normalized in self._session_yolo_projects
       ```

    Note: When app closes, `_session_yolo_projects` is lost = L5 resets automatically.
  </action>
  <verify>
    Run: `python -c "
from src.agent.safety.autonomy import AutonomyLevelService
import tempfile, os
svc = AutonomyLevelService()
path = tempfile.mkdtemp()
svc.set_level(path, 'L5')
print(f'is_yolo={svc.is_yolo_active(path)}')
print(f'level={svc.get_settings(path).level}')
"`
    Expected: is_yolo=True, level=L5
  </verify>
  <done>L5 is tracked in-memory and resets when app closes</done>
</task>

</tasks>

<verification>
- L5 classification returns requires_approval=False for ALL risk levels
- L5 classification bypasses allowlist/blocklist rules entirely
- set_level('L5') stores in _session_yolo_projects but NOT in storage
- set_level('L2') removes project from _session_yolo_projects
- is_yolo_active() returns True only for session L5 projects
- Existing L1-L4 behavior unchanged
</verification>

<success_criteria>
- ActionClassifier.classify() returns requires_approval=False for L5 regardless of risk
- L5 is session-only (not written to SQLite by default)
- Downgrading from L5 removes session tracking and persists new level
- is_yolo_active() correctly identifies L5 sessions
- No regressions to L1-L4 classification or persistence
</success_criteria>

<output>
After completion, create `.planning/phases/14-yolo-mode/14-03-SUMMARY.md`
</output>
