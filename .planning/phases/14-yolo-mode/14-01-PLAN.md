---
phase: 14-yolo-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agent/safety/autonomy.py
  - src/agent/safety/sandbox.py
autonomous: true

must_haves:
  truths:
    - "L5 is a valid autonomy level that can be selected"
    - "All risk levels auto-execute at L5 (no approvals)"
    - "Sandbox detection identifies Docker, WSL, cloud dev environments"
  artifacts:
    - path: "src/agent/safety/autonomy.py"
      provides: "Extended AutonomyLevel with L5"
      contains: "Literal[\"L1\", \"L2\", \"L3\", \"L4\", \"L5\"]"
    - path: "src/agent/safety/sandbox.py"
      provides: "SandboxDetector utility class"
      exports: ["SandboxDetector", "SandboxInfo"]
  key_links:
    - from: "src/agent/safety/autonomy.py"
      to: "AUTONOMY_THRESHOLDS"
      via: "L5 key with all risk levels"
      pattern: "\"L5\".*safe.*moderate.*destructive.*critical"
---

<objective>
Extend the autonomy system to support L5 (YOLO) mode and create sandbox detection utility.

Purpose: L5 is the foundation for YOLO mode - it auto-executes all risk levels without approval. Sandbox detection enables safety warnings when running outside isolated environments.

Output: Extended autonomy types with L5 support, SandboxDetector class for environment detection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-yolo-mode/14-RESEARCH.md
@src/agent/safety/autonomy.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AutonomyLevel to include L5</name>
  <files>src/agent/safety/autonomy.py</files>
  <action>
    Extend the existing autonomy system to support L5 (YOLO) mode:

    1. Update `AutonomyLevel` Literal type to include "L5":
       ```python
       AutonomyLevel = Literal["L1", "L2", "L3", "L4", "L5"]
       ```

    2. Add L5 entry to `AUTONOMY_THRESHOLDS` - ALL risk levels auto-execute:
       ```python
       "L5": {"safe", "moderate", "destructive", "critical"},  # YOLO - everything auto-executes
       ```

    3. Add L5 entry to `AUTONOMY_LABELS`:
       ```python
       "L5": "YOLO",  # Power mode for advanced users
       ```

    4. Add L5 entry to `AUTONOMY_COLORS` - use purple (#8B5CF6) for power mode aesthetic:
       ```python
       "L5": "#8B5CF6",  # Purple - power mode, not warning
       ```

    5. Update `_LEVEL_ORDER` list to include L5:
       ```python
       _LEVEL_ORDER: list[AutonomyLevel] = ["L1", "L2", "L3", "L4", "L5"]
       ```

    6. Add `_session_yolo_projects: set[str]` to AutonomyLevelService for session-only L5 tracking (in-memory only, not persisted)

    7. Update `get_default_level()` to also check for "L5" in validation (though L5 should never be default)

    Note: L5 should NOT be persisted to storage by default - that will be handled in Plan 03.
  </action>
  <verify>
    Run: `python -c "from src.agent.safety.autonomy import AutonomyLevel, AUTONOMY_THRESHOLDS, AUTONOMY_LABELS, AUTONOMY_COLORS; print('L5' in AUTONOMY_THRESHOLDS); print(AUTONOMY_THRESHOLDS['L5']); print(AUTONOMY_LABELS['L5']); print(AUTONOMY_COLORS['L5'])"`
    Expected: True, all four risk levels, "YOLO", "#8B5CF6"
  </verify>
  <done>L5 is a valid AutonomyLevel with threshold that auto-executes all risk levels</done>
</task>

<task type="auto">
  <name>Task 2: Create SandboxDetector utility</name>
  <files>src/agent/safety/sandbox.py</files>
  <action>
    Create a new module for sandbox/isolated environment detection:

    1. Create `src/agent/safety/sandbox.py` with:

    2. Define `SandboxInfo` dataclass:
       ```python
       @dataclass
       class SandboxInfo:
           """Result of sandbox detection."""
           is_sandboxed: bool
           environment: str | None  # "docker", "wsl", "codespaces", "gitpod", "devcontainer", "lxc", "vm", None
           confidence: Literal["high", "medium", "low"]
       ```

    3. Create `SandboxDetector` class with static `detect()` method that checks (in order):
       - Docker: `/.dockerenv` exists OR `/proc/1/cgroup` contains "docker" or "containerd"
       - LXC: `/proc/1/cgroup` contains "lxc"
       - WSL: `/proc/version` contains "microsoft" or "wsl" (case-insensitive)
       - Codespaces: `os.environ.get("CODESPACES") == "true"`
       - Gitpod: `os.environ.get("GITPOD_WORKSPACE_ID")` is set
       - DevContainer: `os.environ.get("REMOTE_CONTAINERS") == "true"`
       - VM (heuristic): `platform.machine().lower()` contains "virtual"

    4. Handle `PermissionError` gracefully when reading `/proc/*` files

    5. Return `SandboxInfo(False, None, "high")` if no sandbox detected

    Note: Be generous with detection (err toward "sandboxed") - false negatives are worse than false positives for user experience.
  </action>
  <verify>
    Run: `python -c "from src.agent.safety.sandbox import SandboxDetector, SandboxInfo; info = SandboxDetector.detect(); print(f'sandboxed={info.is_sandboxed}, env={info.environment}, conf={info.confidence}')"`
    Expected: Outputs sandbox detection result (likely sandboxed=False on local dev machine)
  </verify>
  <done>SandboxDetector can detect Docker, WSL, cloud dev environments with confidence levels</done>
</task>

</tasks>

<verification>
- `python -c "from src.agent.safety.autonomy import *"` imports without error
- `python -c "from src.agent.safety.sandbox import *"` imports without error
- L5 exists in all autonomy dictionaries (thresholds, labels, colors)
- AUTONOMY_THRESHOLDS["L5"] contains all four risk levels
- SandboxDetector.detect() returns SandboxInfo with valid fields
</verification>

<success_criteria>
- AutonomyLevel type includes "L5"
- L5 threshold allows all risk levels to auto-execute
- L5 has "YOLO" label and purple (#8B5CF6) color
- SandboxDetector detects common isolated environments
- No regressions to existing L1-L4 functionality
</success_criteria>

<output>
After completion, create `.planning/phases/14-yolo-mode/14-01-SUMMARY.md`
</output>
