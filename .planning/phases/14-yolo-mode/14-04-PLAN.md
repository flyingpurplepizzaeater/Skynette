---
phase: 14-yolo-mode
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/agent/safety/audit.py
autonomous: true

must_haves:
  truths:
    - "Audit entries capture yolo_mode flag for L5 sessions"
    - "YOLO audit entries store full parameters (no truncation)"
    - "YOLO entries have longer retention period (90 days vs 30)"
  artifacts:
    - path: "src/agent/safety/audit.py"
      provides: "Enhanced YOLO audit logging"
      contains: "yolo_mode"
  key_links:
    - from: "AuditEntry"
      to: "yolo_mode field"
      via: "boolean attribute"
      pattern: "yolo_mode.*bool"
---

<objective>
Enhance audit logging for YOLO mode sessions with extra verbosity and longer retention.

Purpose: When running in YOLO mode, full audit trail is critical for post-incident analysis. Parameters should not be truncated, and entries should be retained longer.

Output: AuditEntry with yolo_mode flag, full_parameters field, extended retention for YOLO entries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-yolo-mode/14-RESEARCH.md
@.planning/phases/14-yolo-mode/14-01-SUMMARY.md
@src/agent/safety/audit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add yolo_mode field to AuditEntry</name>
  <files>src/agent/safety/audit.py</files>
  <action>
    Extend AuditEntry model with YOLO-specific fields:

    1. Add new fields to `AuditEntry` class:
       ```python
       # YOLO mode fields
       yolo_mode: bool = False  # True if executed in L5 mode
       full_parameters: Optional[str] = None  # Untruncated params for YOLO
       ```

    2. Update `to_dict()` method to include new fields:
       ```python
       "yolo_mode": self.yolo_mode,
       "full_parameters": self.full_parameters,
       ```

    3. Update `from_row()` method to read new fields:
       ```python
       yolo_mode=bool(row.get("yolo_mode", 0)),
       full_parameters=row.get("full_parameters"),
       ```
       Note: Use `.get()` for backwards compatibility with existing DB entries.
  </action>
  <verify>
    Run: `python -c "from src.agent.safety.audit import AuditEntry; e = AuditEntry(session_id='s', step_id='st', tool_name='test', risk_level='safe', yolo_mode=True); print(f'yolo={e.yolo_mode}')" `
    Expected: yolo=True
  </verify>
  <done>AuditEntry has yolo_mode and full_parameters fields</done>
</task>

<task type="auto">
  <name>Task 2: Update database schema and log method</name>
  <files>src/agent/safety/audit.py</files>
  <action>
    Update AuditStore for YOLO-aware logging:

    1. Add constant for YOLO retention:
       ```python
       YOLO_RETENTION_DAYS = 90  # Longer retention for YOLO actions
       ```

    2. Update `_init_db()` to add new columns (with migration for existing DBs):
       ```python
       # Add yolo_mode column if not exists
       try:
           cursor.execute("ALTER TABLE agent_audit ADD COLUMN yolo_mode INTEGER DEFAULT 0")
       except sqlite3.OperationalError:
           pass  # Column already exists

       # Add full_parameters column if not exists
       try:
           cursor.execute("ALTER TABLE agent_audit ADD COLUMN full_parameters TEXT")
       except sqlite3.OperationalError:
           pass  # Column already exists
       ```

    3. Update `log()` method to handle YOLO entries:
       - If `entry.yolo_mode` is True, store full parameters without truncation:
         ```python
         if entry.yolo_mode:
             entry.full_parameters = json.dumps(entry.parameters)  # No truncation for YOLO
         ```

    4. Update INSERT statement in `log()` to include new columns:
       - Add `yolo_mode` and `full_parameters` to column list
       - Add corresponding values: `1 if entry.yolo_mode else 0` and `entry.full_parameters`

    5. Update `cleanup_old_entries()` for differential retention:
       ```python
       def cleanup_old_entries(
           self,
           retention_days: int = DEFAULT_RETENTION_DAYS,
           yolo_retention_days: int = YOLO_RETENTION_DAYS,
       ) -> int:
           """Delete old entries, keeping YOLO entries longer."""
           conn = sqlite3.connect(self.db_path)
           cursor = conn.cursor()

           # Regular entries: standard retention
           regular_cutoff = datetime.now(timezone.utc) - timedelta(days=retention_days)
           cursor.execute(
               "DELETE FROM agent_audit WHERE timestamp < ? AND (yolo_mode = 0 OR yolo_mode IS NULL)",
               (regular_cutoff.isoformat(),)
           )
           regular_deleted = cursor.rowcount

           # YOLO entries: longer retention
           yolo_cutoff = datetime.now(timezone.utc) - timedelta(days=yolo_retention_days)
           cursor.execute(
               "DELETE FROM agent_audit WHERE timestamp < ? AND yolo_mode = 1",
               (yolo_cutoff.isoformat(),)
           )
           yolo_deleted = cursor.rowcount

           conn.commit()
           conn.close()

           logger.info(f"Cleaned up {regular_deleted} regular + {yolo_deleted} YOLO entries")
           return regular_deleted + yolo_deleted
       ```
  </action>
  <verify>
    Run: `python -c "
import tempfile
from src.agent.safety.audit import AuditStore, AuditEntry
store = AuditStore(db_path=tempfile.mktemp(suffix='.db'))
entry = AuditEntry(
    session_id='test-session',
    step_id='step1',
    tool_name='file_write',
    parameters={'path': '/tmp/test', 'content': 'x' * 5000},
    risk_level='destructive',
    yolo_mode=True,
)
store.log(entry)
entries = store.query(session_id='test-session')
print(f'yolo_mode={entries[0].yolo_mode}, has_full_params={entries[0].full_parameters is not None}')
"`
    Expected: yolo_mode=True, has_full_params=True
  </verify>
  <done>YOLO audit entries store full parameters and have extended retention</done>
</task>

</tasks>

<verification>
- AuditEntry accepts yolo_mode=True in constructor
- to_dict() includes yolo_mode and full_parameters
- Database schema migrates cleanly (adds columns without breaking existing data)
- YOLO entries store full_parameters without truncation
- cleanup_old_entries() uses 90-day retention for YOLO, 30-day for regular
- Non-YOLO entries still truncate at 4KB (existing behavior unchanged)
</verification>

<success_criteria>
- yolo_mode field persisted to SQLite
- full_parameters captured for YOLO entries (not truncated)
- YOLO entries retained 90 days vs 30 for regular
- Schema migration works on existing databases
- No regressions to regular audit logging
</success_criteria>

<output>
After completion, create `.planning/phases/14-yolo-mode/14-04-SUMMARY.md`
</output>
