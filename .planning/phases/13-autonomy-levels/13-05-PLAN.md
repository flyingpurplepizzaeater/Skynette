---
phase: 13-autonomy-levels
plan: 05
type: execute
wave: 3
depends_on: ["13-01", "13-03"]
files_modified:
  - src/agent/ui/autonomy_badge.py
  - src/agent/ui/autonomy_toggle.py
  - src/agent/ui/agent_panel.py
autonomous: true

must_haves:
  truths:
    - "User sees color-coded autonomy level indicator in agent panel header"
    - "User can click indicator to open quick toggle dropdown"
    - "Level changes are instant (no confirmation dialog)"
    - "Badge shows L1-L4 with corresponding color"
  artifacts:
    - path: "src/agent/ui/autonomy_badge.py"
      provides: "AutonomyBadge component"
      exports: ["AutonomyBadge"]
    - path: "src/agent/ui/autonomy_toggle.py"
      provides: "Quick toggle dropdown"
      exports: ["AutonomyToggle"]
    - path: "src/agent/ui/agent_panel.py"
      provides: "Integrated badge and toggle in header"
      contains: "AutonomyBadge"
  key_links:
    - from: "src/agent/ui/agent_panel.py"
      to: "src/agent/ui/autonomy_badge.py"
      via: "imports AutonomyBadge"
      pattern: "from.*autonomy_badge import"
---

<objective>
Create UI components for autonomy level display and quick toggle

Purpose: Provide visual indication of current autonomy level in agent panel header with instant level switching capability.

Output: `AutonomyBadge` component (color-coded level indicator), `AutonomyToggle` (dropdown for level selection), integrated into `AgentPanel` header.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-autonomy-levels/13-CONTEXT.md
@.planning/phases/13-autonomy-levels/13-RESEARCH.md
@src/agent/ui/agent_panel.py
@src/agent/ui/risk_badge.py
@src/agent/safety/autonomy.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AutonomyBadge component</name>
  <files>src/agent/ui/autonomy_badge.py</files>
  <action>
Create `src/agent/ui/autonomy_badge.py` following the RiskBadge pattern:

```python
"""
Autonomy Badge Component

Color-coded badge showing current autonomy level.
"""

import flet as ft

from src.agent.safety.autonomy import (
    AutonomyLevel,
    AUTONOMY_COLORS,
    AUTONOMY_LABELS,
)
from src.ui.theme import Theme


class AutonomyBadge(ft.Container):
    """
    Color-coded badge displaying autonomy level.

    Shows a colored dot + level label (e.g., "[*] L2" in emerald).
    Follows RiskBadge pattern for consistent styling.
    """

    def __init__(self, level: AutonomyLevel, compact: bool = False):
        """
        Initialize autonomy badge.

        Args:
            level: The autonomy level to display
            compact: If True, show only the dot (no label)
        """
        self.level = level
        self.compact = compact

        color = AUTONOMY_COLORS.get(level, Theme.TEXT_MUTED)
        label = AUTONOMY_LABELS.get(level, level)

        # Build content
        if compact:
            content = ft.Container(
                width=10,
                height=10,
                border_radius=5,
                bgcolor=color,
                tooltip=f"{level}: {label}",
            )
            padding_val = 0
        else:
            content = ft.Row(
                controls=[
                    ft.Container(
                        width=8,
                        height=8,
                        border_radius=4,
                        bgcolor=color,
                    ),
                    ft.Text(
                        level,
                        color=color,
                        size=Theme.FONT_SM,
                        weight=ft.FontWeight.W_500,
                    ),
                ],
                spacing=Theme.SPACING_XS,
            )
            padding_val = ft.padding.symmetric(
                horizontal=Theme.SPACING_SM,
                vertical=2,
            )

        super().__init__(
            content=content,
            bgcolor=f"{color}20",  # 20% opacity background
            border=ft.border.all(1, color),
            border_radius=Theme.RADIUS_SM,
            padding=padding_val,
        )

    def update_level(self, level: AutonomyLevel):
        """Update the displayed autonomy level."""
        self.level = level
        color = AUTONOMY_COLORS.get(level, Theme.TEXT_MUTED)
        label = AUTONOMY_LABELS.get(level, level)

        self.bgcolor = f"{color}20"
        self.border = ft.border.all(1, color)

        if self.compact:
            # Update tooltip
            self.content.tooltip = f"{level}: {label}"
            self.content.bgcolor = color
        else:
            # Update the dot and text
            row = self.content
            if isinstance(row, ft.Row) and len(row.controls) >= 2:
                row.controls[0].bgcolor = color
                row.controls[1].color = color
                row.controls[1].value = level

        self.update()
```
  </action>
  <verify>Component imports: `python -c "from src.agent.ui.autonomy_badge import AutonomyBadge; print('OK')"`</verify>
  <done>AutonomyBadge component is created following RiskBadge pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create AutonomyToggle component</name>
  <files>src/agent/ui/autonomy_toggle.py</files>
  <action>
Create `src/agent/ui/autonomy_toggle.py`:

```python
"""
Autonomy Toggle Component

Quick dropdown for selecting autonomy level.
"""

from typing import Callable, Optional

import flet as ft

from src.agent.safety.autonomy import (
    AutonomyLevel,
    AUTONOMY_COLORS,
    AUTONOMY_LABELS,
)
from src.agent.ui.autonomy_badge import AutonomyBadge
from src.ui.theme import Theme


class AutonomyToggle(ft.Container):
    """
    Clickable autonomy badge that opens a dropdown for level selection.

    Provides instant level switching without confirmation dialog.
    """

    def __init__(
        self,
        level: AutonomyLevel = "L2",
        on_level_change: Optional[Callable[[AutonomyLevel], None]] = None,
    ):
        """
        Initialize autonomy toggle.

        Args:
            level: Initial autonomy level
            on_level_change: Callback when level changes
        """
        self._level = level
        self._on_level_change = on_level_change

        # Badge display
        self._badge = AutonomyBadge(level=level, compact=False)

        # Popup menu for level selection
        self._popup = ft.PopupMenuButton(
            items=self._build_menu_items(),
            tooltip="Change autonomy level",
            content=self._badge,
        )

        super().__init__(
            content=self._popup,
        )

    def _build_menu_items(self) -> list[ft.PopupMenuItem]:
        """Build popup menu items for each level."""
        items = []
        for lvl in ["L1", "L2", "L3", "L4"]:
            color = AUTONOMY_COLORS.get(lvl, Theme.TEXT_MUTED)
            label = AUTONOMY_LABELS.get(lvl, lvl)
            is_current = lvl == self._level

            items.append(ft.PopupMenuItem(
                content=ft.Row(
                    controls=[
                        ft.Container(
                            width=8,
                            height=8,
                            border_radius=4,
                            bgcolor=color,
                        ),
                        ft.Text(
                            f"{lvl}: {label}",
                            color=Theme.TEXT_PRIMARY if is_current else Theme.TEXT_SECONDARY,
                            weight=ft.FontWeight.W_600 if is_current else ft.FontWeight.W_400,
                            size=Theme.FONT_SM,
                        ),
                        ft.Icon(
                            ft.Icons.CHECK,
                            size=14,
                            color=color,
                            visible=is_current,
                        ),
                    ],
                    spacing=Theme.SPACING_SM,
                ),
                on_click=lambda e, l=lvl: self._select_level(l),
            ))

        return items

    def _select_level(self, level: str):
        """Handle level selection from menu."""
        if level in ("L1", "L2", "L3", "L4") and level != self._level:
            self._level = level  # type: ignore
            self._badge.update_level(level)  # type: ignore

            # Rebuild menu to update checkmarks
            self._popup.items = self._build_menu_items()
            self._popup.update()

            # Notify callback
            if self._on_level_change:
                self._on_level_change(level)  # type: ignore

    def set_level(self, level: AutonomyLevel):
        """
        Set the autonomy level programmatically.

        Args:
            level: New autonomy level
        """
        if level != self._level:
            self._level = level
            self._badge.update_level(level)
            self._popup.items = self._build_menu_items()
            self._popup.update()

    @property
    def level(self) -> AutonomyLevel:
        """Get current autonomy level."""
        return self._level
```
  </action>
  <verify>Component imports: `python -c "from src.agent.ui.autonomy_toggle import AutonomyToggle; print('OK')"`</verify>
  <done>AutonomyToggle component is created with popup menu</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into AgentPanel header</name>
  <files>src/agent/ui/agent_panel.py</files>
  <action>
Update `src/agent/ui/agent_panel.py` to include autonomy toggle in header:

1. Add imports at top:
```python
from src.agent.safety.autonomy import AutonomyLevel, get_autonomy_service
from src.agent.ui.autonomy_toggle import AutonomyToggle
```

2. Add instance variable in `__init__`:
```python
self._autonomy_toggle: Optional[AutonomyToggle] = None
self._project_path: Optional[str] = None
```

3. In `build()` method, create the toggle after creating the view mode dropdown:
```python
# Autonomy level toggle
self._autonomy_toggle = AutonomyToggle(
    level=self._get_current_autonomy_level(),
    on_level_change=self._on_autonomy_level_change,
)
```

4. Update the header row to include the toggle (insert before view mode dropdown):
```python
# Header row
self._header = ft.Row(
    controls=[
        ft.Icon(ft.Icons.SMART_TOY, size=18, color=Theme.PRIMARY),
        ft.Text(
            "Agent",
            size=Theme.FONT_MD,
            weight=ft.FontWeight.W_600,
            color=Theme.TEXT_PRIMARY,
        ),
        ft.Container(expand=True),  # Spacer
        self._autonomy_toggle,  # <-- Add this
        self._view_mode_dropdown,
        collapse_with_badge,
    ],
    spacing=Theme.SPACING_SM,
    vertical_alignment=ft.CrossAxisAlignment.CENTER,
)
```

5. Add helper methods:
```python
def _get_current_autonomy_level(self) -> AutonomyLevel:
    """Get current autonomy level for project."""
    svc = get_autonomy_service()
    settings = svc.get_settings(self._project_path)
    return settings.level

def _on_autonomy_level_change(self, level: AutonomyLevel) -> None:
    """Handle autonomy level change from toggle."""
    if self._project_path:
        svc = get_autonomy_service()
        svc.set_level(self._project_path, level)
    # Level is already updated in UI by toggle

def set_project_path(self, project_path: str | None) -> None:
    """
    Set the current project path for autonomy settings.

    Args:
        project_path: Project directory path
    """
    self._project_path = project_path
    if self._autonomy_toggle:
        level = self._get_current_autonomy_level()
        self._autonomy_toggle.set_level(level)
```
  </action>
  <verify>Panel imports work: `python -c "from src.agent.ui.agent_panel import AgentPanel; print('OK')"`</verify>
  <done>AgentPanel header includes autonomy toggle component</done>
</task>

</tasks>

<verification>
- [ ] AutonomyBadge displays correct color for each level
- [ ] AutonomyBadge supports compact mode (dot only)
- [ ] AutonomyToggle opens popup menu on click
- [ ] Level selection updates badge immediately
- [ ] Level change callback is invoked
- [ ] AgentPanel header shows autonomy toggle
- [ ] `set_project_path()` updates toggle to project's level
</verification>

<success_criteria>
1. Color-coded badge visible in panel header (L1=blue, L2=emerald, L3=amber, L4=red)
2. Clicking badge opens dropdown with all four levels
3. Level change is instant (per CONTEXT.md - no friction when escalating)
4. Level persists via AutonomyLevelService
5. Badge styling consistent with existing RiskBadge
</success_criteria>

<output>
After completion, create `.planning/phases/13-autonomy-levels/13-05-SUMMARY.md`
</output>
