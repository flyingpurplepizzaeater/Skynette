---
phase: 13-autonomy-levels
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/storage.py
autonomous: true

must_haves:
  truths:
    - "Project autonomy settings persist to SQLite"
    - "Settings can be retrieved by project path"
    - "Global default autonomy level is configurable"
  artifacts:
    - path: "src/data/storage.py"
      provides: "project_autonomy table, get/set methods"
      contains: "project_autonomy"
  key_links:
    - from: "src/data/storage.py"
      to: "skynette.db"
      via: "sqlite3.connect"
      pattern: "CREATE TABLE.*project_autonomy"
---

<objective>
Add autonomy settings storage schema and methods

Purpose: Persist per-project autonomy levels and rules to SQLite, extending the existing WorkflowStorage pattern.

Output: New `project_autonomy` table in SQLite and methods to get/set project autonomy settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-autonomy-levels/13-CONTEXT.md
@.planning/phases/13-autonomy-levels/13-RESEARCH.md
@src/data/storage.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project_autonomy table to schema</name>
  <files>src/data/storage.py</files>
  <action>
In `WorkflowStorage._init_db()`, add a new table after existing table definitions:

```python
# Project autonomy settings table
cursor.execute("""
    CREATE TABLE IF NOT EXISTS project_autonomy (
        project_path TEXT PRIMARY KEY,
        autonomy_level TEXT NOT NULL DEFAULT 'L2',
        allowlist_rules TEXT,
        blocklist_rules TEXT,
        created_at TEXT,
        updated_at TEXT
    )
""")
```

The table stores:
- `project_path`: Normalized absolute path (primary key)
- `autonomy_level`: L1, L2, L3, or L4 (default L2 = Collaborator)
- `allowlist_rules`: JSON array of rule objects (nullable, for Plan 04)
- `blocklist_rules`: JSON array of rule objects (nullable, for Plan 04)
- `created_at`, `updated_at`: ISO timestamps
  </action>
  <verify>Table created on fresh DB: `python -c "from src.data.storage import WorkflowStorage; import tempfile, os; ws = WorkflowStorage(tempfile.mkdtemp()); print('OK')"`</verify>
  <done>project_autonomy table is created in SQLite schema</done>
</task>

<task type="auto">
  <name>Task 2: Add get/set methods for project autonomy</name>
  <files>src/data/storage.py</files>
  <action>
Add methods to `WorkflowStorage` class:

```python
def get_project_autonomy(self, project_path: str) -> dict:
    """
    Get autonomy settings for a project.

    Args:
        project_path: Project directory path

    Returns:
        Dict with keys: level, allowlist, blocklist
        Falls back to global defaults if project not found
    """
    conn = sqlite3.connect(self.db_path)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # Normalize path
    normalized_path = str(Path(project_path).resolve())

    cursor.execute("""
        SELECT autonomy_level, allowlist_rules, blocklist_rules
        FROM project_autonomy
        WHERE project_path = ?
    """, (normalized_path,))

    row = cursor.fetchone()
    conn.close()

    if row:
        return {
            "level": row["autonomy_level"],
            "allowlist": json.loads(row["allowlist_rules"] or "[]"),
            "blocklist": json.loads(row["blocklist_rules"] or "[]"),
        }

    # Return defaults
    return {
        "level": self.get_setting("default_autonomy_level", "L2"),
        "allowlist": json.loads(self.get_setting("global_allowlist", "[]")),
        "blocklist": json.loads(self.get_setting("global_blocklist", "[]")),
    }

def set_project_autonomy(
    self,
    project_path: str,
    level: str,
    allowlist: list | None = None,
    blocklist: list | None = None,
) -> None:
    """
    Set autonomy settings for a project.

    Args:
        project_path: Project directory path
        level: Autonomy level (L1, L2, L3, L4)
        allowlist: Optional list of allowlist rules
        blocklist: Optional list of blocklist rules
    """
    conn = sqlite3.connect(self.db_path)
    cursor = conn.cursor()

    # Normalize path
    normalized_path = str(Path(project_path).resolve())
    now = datetime.now(UTC).isoformat()

    # Check if exists
    cursor.execute(
        "SELECT created_at FROM project_autonomy WHERE project_path = ?",
        (normalized_path,)
    )
    existing = cursor.fetchone()

    if existing:
        # Update
        cursor.execute("""
            UPDATE project_autonomy
            SET autonomy_level = ?,
                allowlist_rules = ?,
                blocklist_rules = ?,
                updated_at = ?
            WHERE project_path = ?
        """, (
            level,
            json.dumps(allowlist) if allowlist is not None else None,
            json.dumps(blocklist) if blocklist is not None else None,
            now,
            normalized_path,
        ))
    else:
        # Insert
        cursor.execute("""
            INSERT INTO project_autonomy
            (project_path, autonomy_level, allowlist_rules, blocklist_rules, created_at, updated_at)
            VALUES (?, ?, ?, ?, ?, ?)
        """, (
            normalized_path,
            level,
            json.dumps(allowlist) if allowlist is not None else None,
            json.dumps(blocklist) if blocklist is not None else None,
            now,
            now,
        ))

    conn.commit()
    conn.close()
    logger.info(f"Set autonomy level {level} for {normalized_path}")

def delete_project_autonomy(self, project_path: str) -> bool:
    """
    Delete autonomy settings for a project.

    Args:
        project_path: Project directory path

    Returns:
        True if deleted, False if not found
    """
    conn = sqlite3.connect(self.db_path)
    cursor = conn.cursor()

    normalized_path = str(Path(project_path).resolve())

    cursor.execute(
        "DELETE FROM project_autonomy WHERE project_path = ?",
        (normalized_path,)
    )

    deleted = cursor.rowcount > 0
    conn.commit()
    conn.close()

    return deleted
```

Note: Import `Path` from pathlib at top of file if not already imported.
  </action>
  <verify>Methods work: `python -c "from src.data.storage import WorkflowStorage; import tempfile; ws = WorkflowStorage(tempfile.mkdtemp()); ws.set_project_autonomy('/tmp/test', 'L3'); print(ws.get_project_autonomy('/tmp/test'))"`</verify>
  <done>get_project_autonomy, set_project_autonomy, delete_project_autonomy methods are implemented</done>
</task>

</tasks>

<verification>
- [ ] `project_autonomy` table is created in SQLite
- [ ] `get_project_autonomy()` returns dict with level, allowlist, blocklist
- [ ] `get_project_autonomy()` falls back to global default when project not found
- [ ] `set_project_autonomy()` inserts new record or updates existing
- [ ] Project paths are normalized with `Path.resolve()`
- [ ] Timestamps are stored in ISO format
</verification>

<success_criteria>
1. project_autonomy table exists with correct schema
2. Settings persist across storage instance restarts
3. Path normalization prevents duplicate entries for same project
4. Fallback to global defaults works correctly
5. JSON serialization for allowlist/blocklist rules works
</success_criteria>

<output>
After completion, create `.planning/phases/13-autonomy-levels/13-02-SUMMARY.md`
</output>
