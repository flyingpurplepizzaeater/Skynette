---
phase: 11-safety-and-approval-systems
plan: 05
type: execute
wave: 3
depends_on: ["11-01", "11-03"]
files_modified:
  - src/agent/ui/approval_sheet.py
  - src/agent/ui/risk_badge.py
  - src/agent/ui/__init__.py
autonomous: true

must_haves:
  truths:
    - "Approval sheet shows action details and three options: Approve, Approve All Similar, Reject"
    - "Risk badge displays color-coded risk level with label"
    - "Sheet dismissal requires explicit decision (no click-outside dismiss)"
    - "UI components integrate with Theme for light/dark mode"
  artifacts:
    - path: "src/agent/ui/approval_sheet.py"
      provides: "ApprovalSheet Flet BottomSheet component"
      exports: ["ApprovalSheet"]
    - path: "src/agent/ui/risk_badge.py"
      provides: "RiskBadge container component"
      exports: ["RiskBadge"]
  key_links:
    - from: "src/agent/ui/approval_sheet.py"
      to: "src/agent/safety/classification.py"
      via: "ActionClassification import"
      pattern: "ActionClassification"
    - from: "src/agent/ui/risk_badge.py"
      to: "src/agent/safety/classification.py"
      via: "RISK_COLORS import"
      pattern: "RISK_COLORS"
---

<objective>
Create UI components for action approval: RiskBadge and ApprovalSheet

Purpose: User-facing approval interface with clear risk indication
Output: RiskBadge component and ApprovalSheet BottomSheet for approval workflow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-safety-and-approval-systems/11-CONTEXT.md
@.planning/phases/11-safety-and-approval-systems/11-RESEARCH.md
@src/ui/theme.py
@src/agent/ui/cancel_dialog.py (pattern reference)
@src/agent/safety/classification.py (from 11-01)
@src/agent/safety/approval.py (from 11-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RiskBadge component</name>
  <files>src/agent/ui/risk_badge.py</files>
  <action>
Create `src/agent/ui/risk_badge.py`:

```python
"""
Risk Badge Component

Color-coded badge showing action risk level.
"""

import flet as ft

from src.agent.safety.classification import RiskLevel, RISK_COLORS, RISK_LABELS
from src.ui.theme import Theme


class RiskBadge(ft.Container):
    """
    Color-coded badge displaying risk level.

    Shows a colored dot + label (e.g., "[*] Destructive" in orange).
    Follows Theme patterns for consistent styling.
    """

    def __init__(self, risk_level: RiskLevel, compact: bool = False):
        """
        Initialize risk badge.

        Args:
            risk_level: The risk level to display
            compact: If True, show only the dot (no label)
        """
        self.risk_level = risk_level
        self.compact = compact

        color = RISK_COLORS.get(risk_level, Theme.TEXT_MUTED)
        label = RISK_LABELS.get(risk_level, risk_level)

        # Build content
        if compact:
            content = ft.Container(
                width=10,
                height=10,
                border_radius=5,
                bgcolor=color,
                tooltip=label,
            )
            padding_val = 0
        else:
            content = ft.Row(
                controls=[
                    ft.Container(
                        width=8,
                        height=8,
                        border_radius=4,
                        bgcolor=color,
                    ),
                    ft.Text(
                        label,
                        color=color,
                        size=Theme.FONT_SM,
                        weight=ft.FontWeight.W_500,
                    ),
                ],
                spacing=Theme.SPACING_XS,
            )
            padding_val = ft.padding.symmetric(
                horizontal=Theme.SPACING_SM,
                vertical=2,
            )

        super().__init__(
            content=content,
            bgcolor=f"{color}20",  # 20% opacity background
            border=ft.border.all(1, color),
            border_radius=Theme.RADIUS_SM,
            padding=padding_val,
        )

    def update_risk_level(self, risk_level: RiskLevel):
        """Update the displayed risk level."""
        self.risk_level = risk_level
        color = RISK_COLORS.get(risk_level, Theme.TEXT_MUTED)
        label = RISK_LABELS.get(risk_level, risk_level)

        self.bgcolor = f"{color}20"
        self.border = ft.border.all(1, color)

        if not self.compact:
            # Update the dot and text
            row = self.content
            if isinstance(row, ft.Row) and len(row.controls) >= 2:
                row.controls[0].bgcolor = color
                row.controls[1].color = color
                row.controls[1].value = label

        self.update()
```
  </action>
  <verify>Create badge in Flet test: `badge = RiskBadge("critical"); assert badge.risk_level == "critical"`</verify>
  <done>RiskBadge component with color-coded styling for all four risk levels</done>
</task>

<task type="auto">
  <name>Task 2: Create ApprovalSheet bottom sheet component</name>
  <files>src/agent/ui/approval_sheet.py</files>
  <action>
Create `src/agent/ui/approval_sheet.py`:

```python
"""
Approval Sheet Component

Bottom sheet for human-in-the-loop action approval.
"""

import json
from typing import Callable, Optional

import flet as ft

from src.agent.safety.classification import ActionClassification
from src.agent.safety.approval import ApprovalRequest
from src.agent.ui.risk_badge import RiskBadge
from src.ui.theme import Theme


class ApprovalSheet(ft.BottomSheet):
    """
    Bottom sheet for action approval.

    Displays action details and provides Approve/Approve All Similar/Reject options.
    Does not dismiss on outside click - requires explicit decision.
    """

    def __init__(
        self,
        request: ApprovalRequest,
        on_approve: Callable[[bool], None],  # bool = approve_similar
        on_reject: Callable[[], None],
        on_timeout: Optional[Callable[[], None]] = None,
    ):
        """
        Initialize approval sheet.

        Args:
            request: The approval request with classification
            on_approve: Callback when approved (bool indicates approve_similar)
            on_reject: Callback when rejected
            on_timeout: Optional callback for timeout handling
        """
        self.request = request
        self.classification = request.classification
        self.on_approve = on_approve
        self.on_reject = on_reject
        self.on_timeout = on_timeout

        super().__init__(
            content=self._build_content(),
            enable_drag=True,
            show_drag_handle=True,
            is_scroll_controlled=True,
            # Critical: Don't dismiss on outside click - require explicit decision
            dismissible=False,
        )

    def _build_content(self) -> ft.Control:
        """Build the sheet content."""
        # Truncate parameters for display (first 500 chars)
        params_str = json.dumps(self.classification.parameters, indent=2)
        if len(params_str) > 500:
            params_str = params_str[:500] + "\n..."

        return ft.Container(
            padding=Theme.SPACING_LG,
            content=ft.Column(
                controls=[
                    # Header: Risk badge + tool name
                    ft.Row(
                        controls=[
                            RiskBadge(self.classification.risk_level),
                            ft.Text(
                                self.classification.tool_name,
                                weight=ft.FontWeight.BOLD,
                                size=Theme.FONT_LG,
                            ),
                        ],
                        spacing=Theme.SPACING_SM,
                    ),

                    # Reason
                    ft.Text(
                        self.classification.reason,
                        color=Theme.TEXT_SECONDARY,
                        size=Theme.FONT_SM,
                    ),

                    ft.Divider(height=Theme.SPACING_SM),

                    # Parameters preview
                    ft.Text(
                        "Parameters:",
                        size=Theme.FONT_SM,
                        weight=ft.FontWeight.W_500,
                    ),
                    ft.Container(
                        bgcolor=Theme.BG_TERTIARY,
                        border_radius=Theme.RADIUS_SM,
                        padding=Theme.SPACING_SM,
                        content=ft.Text(
                            params_str,
                            font_family="monospace",
                            size=Theme.FONT_XS,
                            selectable=True,
                        ),
                    ),

                    ft.Divider(height=Theme.SPACING_MD),

                    # Action buttons
                    ft.Row(
                        controls=[
                            ft.OutlinedButton(
                                "Reject",
                                on_click=self._handle_reject,
                                style=ft.ButtonStyle(
                                    color=Theme.ERROR,
                                ),
                            ),
                            ft.FilledButton(
                                "Approve",
                                on_click=lambda _: self._handle_approve(False),
                                style=ft.ButtonStyle(
                                    bgcolor=Theme.SUCCESS,
                                    color=Theme.TEXT_PRIMARY,
                                ),
                            ),
                            ft.FilledTonalButton(
                                "Approve All Similar",
                                on_click=lambda _: self._handle_approve(True),
                                tooltip="Auto-approve similar actions in this session",
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.END,
                        spacing=Theme.SPACING_SM,
                    ),
                ],
                spacing=Theme.SPACING_SM,
                tight=True,
                scroll=ft.ScrollMode.AUTO,
            ),
        )

    def _handle_approve(self, approve_similar: bool):
        """Handle approve button click."""
        self.open = False
        self.update()
        self.on_approve(approve_similar)

    def _handle_reject(self, e):
        """Handle reject button click."""
        self.open = False
        self.update()
        self.on_reject()

    def show(self, page: ft.Page):
        """Show the approval sheet."""
        self.open = True
        if self not in page.overlay:
            page.overlay.append(self)
        page.update()

    def hide(self):
        """Hide the approval sheet."""
        self.open = False
        self.update()
```
  </action>
  <verify>Import and instantiate: `from src.agent.ui.approval_sheet import ApprovalSheet`</verify>
  <done>ApprovalSheet BottomSheet with Approve/Approve All Similar/Reject buttons</done>
</task>

<task type="auto">
  <name>Task 3: Export UI components and add to agent package</name>
  <files>src/agent/ui/__init__.py, src/agent/__init__.py</files>
  <action>
1. Update `src/agent/ui/__init__.py` to export new components:

```python
"""
Agent UI Components

Flet components for agent interaction.
"""

from .cancel_dialog import CancelDialog
from .status_indicator import AgentStatusIndicator
from .risk_badge import RiskBadge
from .approval_sheet import ApprovalSheet

__all__ = [
    "CancelDialog",
    "AgentStatusIndicator",
    "RiskBadge",
    "ApprovalSheet",
]
```

2. Update `src/agent/__init__.py` to include new UI exports:
   - Add: `from src.agent.ui import RiskBadge, ApprovalSheet`
   - Add to __all__ list

Ensure alphabetical ordering of imports per codebase convention.
  </action>
  <verify>`from src.agent import RiskBadge, ApprovalSheet`</verify>
  <done>UI components exported from src.agent.ui and src.agent packages</done>
</task>

</tasks>

<verification>
```python
# Verification script
import flet as ft
from src.agent import RiskBadge, ApprovalSheet, ApprovalRequest, ActionClassification

# Test RiskBadge
def test_badge():
    for level in ["safe", "moderate", "destructive", "critical"]:
        badge = RiskBadge(level)
        assert badge.risk_level == level
        assert badge.bgcolor is not None

    # Test compact mode
    compact = RiskBadge("critical", compact=True)
    assert compact.compact == True

    print("RiskBadge tests passed!")

test_badge()

# Test ApprovalSheet structure
def test_sheet():
    classification = ActionClassification(
        risk_level="destructive",
        reason="Destructive: modifies file /tmp/test.txt",
        requires_approval=True,
        tool_name="file_write",
        parameters={"path": "/tmp/test.txt", "content": "hello world"},
    )

    request = ApprovalRequest(
        classification=classification,
        step_id="step-1",
        session_id="test-session",
    )

    approved = []
    rejected = []

    sheet = ApprovalSheet(
        request=request,
        on_approve=lambda similar: approved.append(similar),
        on_reject=lambda: rejected.append(True),
    )

    # Verify structure
    assert sheet.dismissible == False  # Requires explicit decision
    assert sheet.request is request

    # Simulate button clicks
    sheet._handle_approve(False)
    assert approved == [False]

    sheet._handle_approve(True)
    assert approved == [False, True]

    sheet._handle_reject(None)
    assert rejected == [True]

    print("ApprovalSheet tests passed!")

test_sheet()

print("All UI component tests passed!")
```
</verification>

<success_criteria>
- RiskBadge shows colored dot + label for all four risk levels
- RiskBadge has compact mode (dot only) with tooltip
- ApprovalSheet displays classification details in bottom sheet
- ApprovalSheet has three buttons: Reject, Approve, Approve All Similar
- ApprovalSheet is not dismissible by clicking outside (dismissible=False)
- Parameters are truncated to 500 chars for display
- All components use Theme for colors and spacing
- Components exported from src.agent.ui and src.agent
</success_criteria>

<output>
After completion, create `.planning/phases/11-safety-and-approval-systems/11-05-SUMMARY.md`
</output>
