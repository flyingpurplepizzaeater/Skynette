---
phase: 12-ui-integration
plan: 05
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - src/agent/ui/audit_view.py
  - src/agent/ui/agent_panel.py
  - src/agent/ui/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can see scrollable audit trail of actions"
    - "User can filter audit by risk level"
    - "Each entry shows tool name, risk badge, timestamp, duration"
    - "Clicking entry expands to show full details"
    - "Audit updates in real-time during execution"
  artifacts:
    - path: "src/agent/ui/audit_view.py"
      provides: "Audit trail UI component"
      min_lines: 150
      exports: ["AuditTrailView"]
  key_links:
    - from: "src/agent/ui/audit_view.py"
      to: "AuditStore"
      via: "query() method"
      pattern: "audit_store\\.query"
    - from: "src/agent/ui/agent_panel.py"
      to: "AuditTrailView"
      via: "integration"
      pattern: "AuditTrailView"
---

<objective>
Create the audit trail UI component showing action history with filtering.

Purpose: UI-05 requires step-by-step audit trail visible and scrollable in UI.

Output: AuditTrailView component integrated into AgentPanel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ui-integration/12-CONTEXT.md
@.planning/phases/12-ui-integration/12-RESEARCH.md

# Data source
@src/agent/safety/audit.py
@src/agent/ui/risk_badge.py
@src/ui/theme.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuditTrailView component</name>
  <files>src/agent/ui/audit_view.py</files>
  <action>
Create AuditTrailView extending ft.Column for displaying audit entries.

**AuditEntryRow(ft.Container):**
- Displays single AuditEntry
- Collapsed view:
  - Row: RiskBadge (compact) + tool_name + timestamp (HH:MM:SS) + duration_ms
  - Approval badge if approval_required (approved/rejected/timeout)
- Expanded view (on click):
  - Parameters (truncated code block)
  - Result or error
  - Full timestamp
  - approved_by info
- Use ExpansionPanel or custom toggle

**AuditTrailView(ft.Column):**
- Constructor: `__init__(self, session_id: Optional[str] = None)`
- _session_id: str
- _filter_risk: Optional[RiskLevel] = None
- _entries: list[AuditEntry] = []
- _audit_store: AuditStore

**Layout:**
- Header row: "Audit Trail" label + filter dropdown + refresh button
- Filter dropdown: All, Safe, Moderate, Destructive, Critical
- ListView with AuditEntryRow items
- auto_scroll=False (user controls scroll)

**Methods:**
- refresh(): Query AuditStore and rebuild list
- set_session(session_id: str): Change session and refresh
- set_filter(risk_level: Optional[RiskLevel]): Apply filter and refresh
- add_entry(entry: AuditEntry): Add single entry to top of list (for real-time updates)
- _build_entry_row(entry: AuditEntry) -> AuditEntryRow

**Real-time updates:**
- When new audit entries logged, add_entry() inserts at top
- Scroll position preserved (auto_scroll=False)

**Summary row at bottom:**
- Query get_session_summary() from AuditStore
- Show: "N total | N approved | N rejected | Nms total"
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/audit_view.py`</verify>
  <done>AuditTrailView renders entries with filtering and expansion</done>
</task>

<task type="auto">
  <name>Task 2: Integrate into AgentPanel</name>
  <files>src/agent/ui/agent_panel.py</files>
  <action>
Add AuditTrailView to AgentPanel layout.

**Layout changes:**
- Content area becomes Column with tabs or sections:
  - Steps section (StepViewSwitcher) - collapsible
  - Plan section (PlanViewSwitcher) - collapsible
  - Audit section (AuditTrailView) - collapsible

Use ft.ExpansionPanelList or simple collapsible sections with show/hide.

**Event handler additions:**
- On "audit_logged" event (if emitter emits it): call audit_view.add_entry()
- Alternatively: refresh audit on step_completed events

**Wire session:**
- When execution starts (plan_created event): call audit_view.set_session(session_id)
- Extract session_id from event.data

**Layout suggestion:**
```python
self._sections = ft.Column([
    # Header with toggle and view selector
    self._build_header(),
    # Collapsible sections
    ft.ExpansionPanelList(
        elevation=0,
        divider_color=Theme.BORDER,
        controls=[
            ft.ExpansionPanel(
                header=ft.Text("Steps"),
                content=self._step_switcher,
                bgcolor=Theme.BG_SECONDARY,
            ),
            ft.ExpansionPanel(
                header=ft.Text("Plan"),
                content=self._plan_switcher,
                bgcolor=Theme.BG_SECONDARY,
            ),
            ft.ExpansionPanel(
                header=ft.Text("Audit Trail"),
                content=self._audit_view,
                bgcolor=Theme.BG_SECONDARY,
            ),
        ],
    ),
])
```
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/agent_panel.py`</verify>
  <done>AuditTrailView integrated into AgentPanel with collapsible sections</done>
</task>

<task type="auto">
  <name>Task 3: Update exports and test</name>
  <files>src/agent/ui/__init__.py</files>
  <action>
Add exports:
- from src.agent.ui.audit_view import AuditTrailView, AuditEntryRow

Add tests in tests/agent/ui/test_audit_view.py:
```python
import pytest
from unittest.mock import MagicMock, patch
from datetime import datetime, timezone

def test_audit_view_creation():
    """Test AuditTrailView creates without errors."""
    with patch('src.agent.ui.audit_view.get_audit_store') as mock_get:
        mock_store = MagicMock()
        mock_store.query.return_value = []
        mock_get.return_value = mock_store

        from src.agent.ui.audit_view import AuditTrailView
        view = AuditTrailView(session_id="test-session")
        assert view is not None

def test_audit_entry_row_display():
    """Test AuditEntryRow renders entry."""
    from src.agent.ui.audit_view import AuditEntryRow
    from src.agent.safety.audit import AuditEntry

    entry = AuditEntry(
        session_id="test",
        step_id="step-1",
        tool_name="file_read",
        risk_level="safe",
        approval_decision="not_required",
        duration_ms=150.5,
    )
    row = AuditEntryRow(entry)
    assert row is not None

def test_audit_view_filter():
    """Test filtering by risk level."""
    with patch('src.agent.ui.audit_view.get_audit_store') as mock_get:
        mock_store = MagicMock()
        mock_store.query.return_value = []
        mock_get.return_value = mock_store

        from src.agent.ui.audit_view import AuditTrailView
        view = AuditTrailView(session_id="test")

        view.set_filter("destructive")
        mock_store.query.assert_called_with(
            session_id="test",
            risk_level="destructive",
            limit=100,
        )
```

Run: `python -m pytest tests/agent/ui/test_audit_view.py -v`
  </action>
  <verify>pytest tests/agent/ui/test_audit_view.py passes</verify>
  <done>AuditTrailView exported and tested</done>
</task>

</tasks>

<verification>
- [ ] AuditTrailView shows list of entries
- [ ] Risk filter dropdown works
- [ ] Entry expansion shows full details
- [ ] Real-time updates via add_entry()
- [ ] Summary row shows statistics
- [ ] Integrated into AgentPanel with collapsible sections
</verification>

<success_criteria>
Scrollable, filterable audit trail shows all agent actions with expand-for-details pattern. Updates in real-time during execution.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ui-integration/12-05-SUMMARY.md`
</output>
