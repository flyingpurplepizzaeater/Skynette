---
phase: 12-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agent/ui/agent_panel.py
  - src/agent/ui/panel_preferences.py
  - src/agent/ui/__init__.py
autonomous: true

must_haves:
  truths:
    - "Agent panel renders as resizable right sidebar"
    - "Panel width persists across sessions"
    - "Panel visibility toggle works and persists"
    - "Panel subscribes to AgentEventEmitter and receives events"
    - "Panel shows badge indicator when collapsed and events pending"
  artifacts:
    - path: "src/agent/ui/agent_panel.py"
      provides: "Main AgentPanel component"
      min_lines: 150
    - path: "src/agent/ui/panel_preferences.py"
      provides: "Panel preference storage and loading"
      exports: ["PanelPreferences", "get_panel_preferences"]
  key_links:
    - from: "src/agent/ui/agent_panel.py"
      to: "AgentEventEmitter"
      via: "subscribe()"
      pattern: "emitter\\.subscribe"
    - from: "src/agent/ui/panel_preferences.py"
      to: "WorkflowStorage"
      via: "get_setting/set_setting"
      pattern: "storage\\.(get|set)_setting"
---

<objective>
Create the core AgentPanel component - a resizable right sidebar that subscribes to agent events.

Purpose: UI-01 requires a dedicated panel for agent interaction. This is the container that will hold all agent UI components (steps, plans, audit trail).

Output: AgentPanel class with resize, visibility toggle, badge indicator, event subscription, and preference persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ui-integration/12-CONTEXT.md
@.planning/phases/12-ui-integration/12-RESEARCH.md

# Key patterns to follow
@src/ui/components/code_editor/resizable_panel.py
@src/agent/ui/status_indicator.py
@src/agent/events/emitter.py
@src/data/storage.py
@src/ui/theme.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create panel preferences module</name>
  <files>src/agent/ui/panel_preferences.py</files>
  <action>
Create PanelPreferences dataclass and helper functions to persist panel state.

Fields:
- width: int (default 350, min 280, max 600)
- visible: bool (default True)
- step_view_mode: Literal["checklist", "timeline", "cards"] (default "checklist")
- plan_view_mode: Literal["list", "tree"] (default "list")
- approval_detail_level: Literal["minimal", "detailed", "progressive"] (default "detailed")

Functions:
- get_panel_preferences() -> PanelPreferences: Load from WorkflowStorage using get_setting()
- save_panel_preferences(prefs: PanelPreferences): Save to WorkflowStorage using set_setting()

Use settings keys prefixed with "agent_panel_" (e.g., "agent_panel_width", "agent_panel_visible").

Import storage: `from src.data.storage import WorkflowStorage`
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/panel_preferences.py`</verify>
  <done>PanelPreferences loads/saves all 5 fields via WorkflowStorage</done>
</task>

<task type="auto">
  <name>Task 2: Create AgentPanel core component</name>
  <files>src/agent/ui/agent_panel.py</files>
  <action>
Create AgentPanel class extending ft.Row with:

**Layout:**
- Divider (GestureDetector, 4px wide, cursor RESIZE_LEFT_RIGHT) on left edge
- Content container on right with width from preferences
- Note: For right sidebar, moving left = wider (subtract delta_x)

**Properties:**
- _width: int
- _visible: bool
- _subscription: Optional[EventSubscription]
- _page: ft.Page
- _badge_count: int (for pending notifications)
- _content_area: ft.Container (placeholder, will hold step/plan views later)
- _header: ft.Row with title and collapse button

**Methods:**
- __init__(self, page: ft.Page): Load preferences, build layout
- build(self): Create divider + content container structure
- _on_drag_update(self, e: DragUpdateEvent): Resize logic (new_width = width - e.delta_x for right sidebar)
- toggle_visibility(self): Toggle visible, save preference, update badge visibility
- set_visible(self, visible: bool): Explicit set visibility
- start_listening(self, emitter: AgentEventEmitter): Subscribe and start event loop
- stop_listening(self): Close subscription
- _event_loop(self): Async for loop over subscription, route to handlers (placeholder handlers for now)
- _increment_badge(self): If collapsed, increment badge_count
- _clear_badge(self): Reset badge_count to 0

**Header:**
- Title: "Agent" with icon
- Collapse button (ft.IconButton with CHEVRON_RIGHT icon)

**Styling:**
- Use Theme.BG_SECONDARY for content background
- Use Theme.BORDER for divider color
- MIN_WIDTH = 280, MAX_WIDTH = 600, DEFAULT_WIDTH = 350

**Badge indicator:**
- Show small Badge(count) on collapse button when _visible=False and _badge_count > 0
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/agent_panel.py`</verify>
  <done>AgentPanel renders, resizes via drag, toggles visibility, subscribes to emitter</done>
</task>

<task type="auto">
  <name>Task 3: Update exports and verify integration</name>
  <files>src/agent/ui/__init__.py</files>
  <action>
Add exports for new components:
- from src.agent.ui.agent_panel import AgentPanel
- from src.agent.ui.panel_preferences import PanelPreferences, get_panel_preferences, save_panel_preferences

Write a quick integration test script in tests/agent/ui/test_agent_panel.py:
```python
import pytest
from unittest.mock import MagicMock, patch

def test_panel_preferences_defaults():
    """Test preference defaults without storage."""
    with patch('src.agent.ui.panel_preferences.WorkflowStorage') as MockStorage:
        mock_storage = MagicMock()
        mock_storage.get_setting.return_value = None
        MockStorage.return_value = mock_storage

        from src.agent.ui.panel_preferences import get_panel_preferences
        prefs = get_panel_preferences()

        assert prefs.width == 350
        assert prefs.visible == True
        assert prefs.step_view_mode == "checklist"

def test_agent_panel_imports():
    """Test AgentPanel can be imported."""
    from src.agent.ui import AgentPanel, PanelPreferences
    assert AgentPanel is not None
    assert PanelPreferences is not None
```

Run: `python -m pytest tests/agent/ui/test_agent_panel.py -v`
  </action>
  <verify>pytest tests/agent/ui/test_agent_panel.py passes</verify>
  <done>AgentPanel and PanelPreferences exported, basic tests pass</done>
</task>

</tasks>

<verification>
- [ ] AgentPanel class exists and extends ft.Row
- [ ] Panel width respects MIN/MAX bounds
- [ ] Drag resize works (delta_x inverted for right sidebar)
- [ ] Visibility toggle saves to preferences
- [ ] Subscription to AgentEventEmitter works
- [ ] Badge shows when collapsed with pending events
- [ ] All exports available from src.agent.ui
</verification>

<success_criteria>
AgentPanel renders as a resizable right sidebar container, subscribes to events, persists preferences, and shows notification badge when collapsed.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ui-integration/12-01-SUMMARY.md`
</output>
