---
phase: 12-ui-integration
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/agent/ui/plan_views.py
  - src/agent/ui/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can see execution plan in list view before execution"
    - "User can switch between list and tree views"
    - "Plan updates in real-time when agent replans"
    - "Dependencies shown visually in tree view"
    - "View mode persists across sessions"
  artifacts:
    - path: "src/agent/ui/plan_views.py"
      provides: "Plan visualization components"
      min_lines: 180
      exports: ["PlanListView", "PlanTreeView", "PlanViewSwitcher"]
  key_links:
    - from: "src/agent/ui/plan_views.py"
      to: "AgentPlan"
      via: "model import"
      pattern: "from src\\.agent\\.models\\.plan import.*AgentPlan"
---

<objective>
Create plan visualization components with list and tree views.

Purpose: UI-04 requires visual plan display before execution begins. Users should see what the agent intends to do.

Output: PlanListView, PlanTreeView, and PlanViewSwitcher for the execution plan.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ui-integration/12-CONTEXT.md
@.planning/phases/12-ui-integration/12-RESEARCH.md

# Models and patterns
@src/agent/models/plan.py
@src/ui/theme.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plan view components</name>
  <files>src/agent/ui/plan_views.py</files>
  <action>
Create plan visualization components.

**PlanHeader(ft.Container):**
- Shows plan.overview text
- Task: plan.task
- Step count: "N steps"
- Styled with Theme.BG_TERTIARY background

**PlanListView(ft.Column):**
- Header: PlanHeader
- Numbered list of steps using ft.ListView
- Each row: number badge + description + tool icon (if tool_name)
- Highlight dependencies with subtle icon
- Constructor: `__init__(self, plan: Optional[AgentPlan] = None)`
- `set_plan(plan: AgentPlan)`: Replace plan
- `update_step_status(step_id, status)`: Update visual for step

**PlanTreeView(ft.Column):**
- Header: PlanHeader
- Tree structure showing dependencies
- Root nodes: steps with no dependencies
- Child nodes: steps that depend on parent
- Use indentation + connecting lines to show hierarchy
- Steps with multiple dependencies shown under first dependency
- Constructor: `__init__(self, plan: Optional[AgentPlan] = None)`
- `set_plan(plan: AgentPlan)`: Build tree from dependencies
- `_build_tree(steps)`: Create tree structure from step.dependencies

Tree building algorithm:
```python
def _build_tree(self, steps: list[PlanStep]) -> list[ft.Control]:
    """Build tree structure from step dependencies."""
    # Find roots (no dependencies)
    roots = [s for s in steps if not s.dependencies]
    # Build recursive tree
    def build_node(step, depth=0):
        # Create row with indentation
        children = [s for s in steps if step.id in s.dependencies]
        return ft.Column([
            _step_row(step, depth),
            *[build_node(c, depth+1) for c in children]
        ])
    return [build_node(r) for r in roots]
```

**PlanViewSwitcher(ft.AnimatedSwitcher):**
- Constructor: `__init__(self, mode: str, plan: Optional[AgentPlan] = None)`
- `set_view_mode(mode: str)`: Switch between "list" and "tree"
- `set_plan(plan: AgentPlan)`: Update plan in current view
- Properties: duration=200, transition=FADE

**Shared styling:**
- Tool icon based on tool_name (ft.Icons.CODE for code tools, ft.Icons.FOLDER for file tools, etc.)
- Step number badge: small circle with number
- Use Theme.SPACING_SM between items
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/plan_views.py`</verify>
  <done>PlanListView and PlanTreeView render plans with dependencies visualized</done>
</task>

<task type="auto">
  <name>Task 2: Update exports and add tests</name>
  <files>src/agent/ui/__init__.py</files>
  <action>
Add exports:
- from src.agent.ui.plan_views import PlanListView, PlanTreeView, PlanViewSwitcher

Add tests in tests/agent/ui/test_plan_views.py:
```python
import pytest
from src.agent.models.plan import AgentPlan, PlanStep

def test_plan_list_view_creation():
    """Test PlanListView renders plan."""
    from src.agent.ui.plan_views import PlanListView

    plan = AgentPlan(
        task="Test task",
        overview="Test overview",
        steps=[
            PlanStep(id="1", description="Step 1"),
            PlanStep(id="2", description="Step 2", dependencies=["1"]),
        ]
    )
    view = PlanListView(plan)
    assert view.controls is not None

def test_plan_tree_view_dependencies():
    """Test PlanTreeView builds tree from dependencies."""
    from src.agent.ui.plan_views import PlanTreeView

    plan = AgentPlan(
        task="Test task",
        overview="Test overview",
        steps=[
            PlanStep(id="1", description="Root step"),
            PlanStep(id="2", description="Child step", dependencies=["1"]),
            PlanStep(id="3", description="Grandchild", dependencies=["2"]),
        ]
    )
    view = PlanTreeView(plan)
    # Tree should have single root
    assert len(view._roots) == 1

def test_plan_view_switcher():
    """Test PlanViewSwitcher changes mode."""
    from src.agent.ui.plan_views import PlanViewSwitcher

    plan = AgentPlan(task="Test", overview="Overview", steps=[])
    switcher = PlanViewSwitcher("list", plan)

    switcher.set_view_mode("tree")
    assert switcher._current_mode == "tree"
```

Run: `python -m pytest tests/agent/ui/test_plan_views.py -v`
  </action>
  <verify>pytest tests/agent/ui/test_plan_views.py passes</verify>
  <done>Plan views exported and tested</done>
</task>

</tasks>

<verification>
- [ ] PlanListView renders numbered step list
- [ ] PlanTreeView shows hierarchical dependency structure
- [ ] Tree indentation correctly shows parent-child relationships
- [ ] PlanViewSwitcher animates between modes
- [ ] Empty plan handled gracefully
- [ ] Tool icons shown where applicable
</verification>

<success_criteria>
Plan visualization shows what agent intends to do before execution. List view for simple scanning, tree view for understanding dependencies.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ui-integration/12-03-SUMMARY.md`
</output>
