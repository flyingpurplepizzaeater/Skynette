---
phase: 12-ui-integration
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/agent/ui/approval_sheet.py
  - src/agent/ui/approval_detail_levels.py
  - src/agent/ui/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can edit action parameters before approving"
    - "User can choose detail level (minimal, detailed, progressive)"
    - "Remember choice checkbox works for session/type scope"
    - "Approval sheet shows batch approval for similar actions"
  artifacts:
    - path: "src/agent/ui/approval_sheet.py"
      provides: "Enhanced ApprovalSheet with editing"
      min_lines: 200
    - path: "src/agent/ui/approval_detail_levels.py"
      provides: "Detail level renderers"
      exports: ["render_minimal", "render_detailed", "render_progressive"]
  key_links:
    - from: "src/agent/ui/approval_sheet.py"
      to: "ApprovalRequest"
      via: "modified_params support"
      pattern: "modified_params"
---

<objective>
Enhance ApprovalSheet with parameter editing, detail levels, and batch approval UI.

Purpose: UI-03 requires approval dialogs with accept/reject/modify options. Users need control over what gets approved.

Output: Enhanced ApprovalSheet with editable parameters and configurable detail levels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ui-integration/12-CONTEXT.md
@.planning/phases/12-ui-integration/12-RESEARCH.md
@.planning/phases/11-safety-and-approval-systems/11-05-SUMMARY.md

# Existing implementation
@src/agent/ui/approval_sheet.py
@src/agent/safety/approval.py
@src/agent/safety/classification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create detail level renderers</name>
  <files>src/agent/ui/approval_detail_levels.py</files>
  <action>
Create functions that render different detail levels for approval content.

**render_minimal(classification: ActionClassification) -> ft.Control:**
- Tool name + risk badge only
- One-line summary
- No parameters shown

**render_detailed(classification: ActionClassification) -> ft.Control:**
- Tool name + risk badge
- Full reason text
- Parameters in scrollable code block (existing behavior)
- Truncated to 500 chars

**render_progressive(classification: ActionClassification, expanded: bool = False) -> ft.Control:**
- Start minimal
- "Show details" expand button
- On expand: show full details
- Returns Container with ExpansionTile or similar pattern

All functions return ft.Container or ft.Column that can be placed in ApprovalSheet content area.

Use Theme for colors and spacing.
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/approval_detail_levels.py`</verify>
  <done>Three detail level renderers created</done>
</task>

<task type="auto">
  <name>Task 2: Enhance ApprovalSheet with editing and detail levels</name>
  <files>src/agent/ui/approval_sheet.py</files>
  <action>
Enhance existing ApprovalSheet class:

**Add to __init__:**
- detail_level: Literal["minimal", "detailed", "progressive"] = "detailed"
- _modified_params: Optional[dict] = None
- _edit_mode: bool = False
- _remember_scope: Optional[str] = None  # "session" or "type"

**Add parameter editing:**
- "Edit" button next to parameters section
- On click: switch to editable TextField (multiline, monospace)
- Parse JSON on edit complete
- Store in _modified_params
- "Cancel edit" to revert

**Add remember choice section:**
- ft.Checkbox: "Remember this choice"
- ft.Dropdown: "For this session" / "For this tool type"
- Only visible when checkbox checked
- Pass scope to callback

**Add batch approval support:**
- If multiple similar requests pending (from ApprovalManager.get_pending())
- Show "Approve N similar actions?" card
- Expandable list showing each action
- Single approve button for all

**Update _build_content():**
- Import render functions from approval_detail_levels
- Use detail_level to select renderer
- Add edit button and remember choice UI

**Update callbacks:**
- on_approve now receives: (approve_similar: bool, modified_params: Optional[dict], remember_scope: Optional[str])
- Pass _modified_params if edited

Note: This is backward-compatible. Old callbacks with single bool arg still work.
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/approval_sheet.py`</verify>
  <done>ApprovalSheet supports editing, detail levels, and batch approval</done>
</task>

<task type="auto">
  <name>Task 3: Update exports and test</name>
  <files>src/agent/ui/__init__.py</files>
  <action>
Add exports:
- from src.agent.ui.approval_detail_levels import render_minimal, render_detailed, render_progressive

Add tests in tests/agent/ui/test_approval_sheet_enhanced.py:
```python
import pytest
from unittest.mock import MagicMock
from src.agent.safety.classification import ActionClassification

def test_detail_level_minimal():
    """Test minimal detail level renders."""
    from src.agent.ui.approval_detail_levels import render_minimal

    classification = ActionClassification(
        risk_level="moderate",
        reason="Test reason",
        requires_approval=True,
        tool_name="test_tool",
        parameters={"key": "value"},
    )
    content = render_minimal(classification)
    assert content is not None

def test_detail_level_progressive():
    """Test progressive detail level with expansion."""
    from src.agent.ui.approval_detail_levels import render_progressive

    classification = ActionClassification(
        risk_level="destructive",
        reason="Test reason",
        requires_approval=True,
        tool_name="file_delete",
        parameters={"path": "/tmp/test"},
    )
    content = render_progressive(classification, expanded=False)
    assert content is not None

def test_approval_sheet_with_detail_level():
    """Test ApprovalSheet accepts detail_level."""
    from src.agent.ui.approval_sheet import ApprovalSheet
    from src.agent.safety.approval import ApprovalRequest

    request = ApprovalRequest()
    request.classification = ActionClassification(
        risk_level="moderate",
        reason="Test",
        requires_approval=True,
        tool_name="test",
        parameters={},
    )

    sheet = ApprovalSheet(
        request=request,
        on_approve=MagicMock(),
        on_reject=MagicMock(),
        detail_level="minimal",
    )
    assert sheet is not None
```

Run: `python -m pytest tests/agent/ui/test_approval_sheet_enhanced.py -v`
  </action>
  <verify>pytest tests/agent/ui/test_approval_sheet_enhanced.py passes</verify>
  <done>Enhanced ApprovalSheet tested with all detail levels</done>
</task>

</tasks>

<verification>
- [ ] Minimal detail level shows tool name + badge only
- [ ] Detailed level shows full parameters
- [ ] Progressive level expands on demand
- [ ] Edit button enables parameter editing
- [ ] JSON parsing validates edited parameters
- [ ] Remember choice checkbox with scope dropdown
- [ ] Batch approval shows count and list
</verification>

<success_criteria>
Users can configure approval detail level, edit parameters before approving, and batch approve similar actions.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ui-integration/12-04-SUMMARY.md`
</output>
