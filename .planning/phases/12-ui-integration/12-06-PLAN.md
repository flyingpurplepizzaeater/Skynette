---
phase: 12-ui-integration
plan: 06
type: execute
wave: 3
depends_on: ["12-01"]
files_modified:
  - src/agent/ui/task_history.py
  - src/agent/ui/__init__.py
autonomous: true

must_haves:
  truths:
    - "User can see list of past agent tasks"
    - "Each task shows description, timestamp, and status"
    - "User can click to replay a task"
    - "History loads from TraceStore"
  artifacts:
    - path: "src/agent/ui/task_history.py"
      provides: "Task history UI component"
      min_lines: 120
      exports: ["TaskHistoryView"]
  key_links:
    - from: "src/agent/ui/task_history.py"
      to: "TraceStore"
      via: "get_sessions() method"
      pattern: "trace_store\\.get_sessions"
---

<objective>
Create task history component showing past agent executions with replay capability.

Purpose: UI-06 requires task history with replay capability.

Output: TaskHistoryView component that lists past tasks and allows replay.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ui-integration/12-CONTEXT.md
@.planning/phases/12-ui-integration/12-RESEARCH.md

# Data source
@src/agent/observability/trace_store.py
@src/agent/observability/trace_models.py
@src/ui/theme.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaskHistoryView component</name>
  <files>src/agent/ui/task_history.py</files>
  <action>
Create TaskHistoryView extending ft.Column.

**TaskSessionRow(ft.Container):**
- Displays single TraceSession
- Layout:
  - Row: Status icon + task description (truncated to 50 chars) + timestamp
  - Subtitle: total_tokens, total_cost_usd, status
- Status icons:
  - running: ft.Icons.PLAY_CIRCLE (Theme.PRIMARY)
  - completed: ft.Icons.CHECK_CIRCLE (Theme.SUCCESS)
  - failed: ft.Icons.ERROR (Theme.ERROR)
  - cancelled: ft.Icons.CANCEL (Theme.WARNING)
- Replay button: ft.IconButton(icon=ft.Icons.REPLAY)
- On click: expand to show more details or trigger replay callback

**TaskHistoryView(ft.Column):**
- Constructor: `__init__(self, on_replay: Optional[Callable[[str], None]] = None)`
- _trace_store: TraceStore
- _sessions: list[TraceSession]
- _on_replay: callback to execute when replay clicked

**Layout:**
- Header: "Recent Tasks" label + refresh button
- ListView with TaskSessionRow items
- Pagination: "Load more" button if more than 20 sessions
- Empty state: "No tasks yet" message

**Methods:**
- refresh(): Load sessions from TraceStore.get_sessions()
- load_more(): Increase offset and append more sessions
- _on_replay_click(task: str): Call on_replay callback with task description
- _build_session_row(session: TraceSession) -> TaskSessionRow

**Date grouping (optional enhancement):**
- Group by date: "Today", "Yesterday", "This week", etc.
- Date headers between groups

**Session detail expansion:**
- On row click: show session details inline
  - Token count, cost
  - Duration (completed_at - started_at)
  - Option to view full trace (link to devtools/trace viewer)
  </action>
  <verify>Python syntax check: `python -m py_compile src/agent/ui/task_history.py`</verify>
  <done>TaskHistoryView renders past sessions with replay buttons</done>
</task>

<task type="auto">
  <name>Task 2: Update exports and test</name>
  <files>src/agent/ui/__init__.py</files>
  <action>
Add exports:
- from src.agent.ui.task_history import TaskHistoryView, TaskSessionRow

Add tests in tests/agent/ui/test_task_history.py:
```python
import pytest
from unittest.mock import MagicMock, patch
from datetime import datetime, timezone

def test_task_history_view_creation():
    """Test TaskHistoryView creates and loads sessions."""
    with patch('src.agent.ui.task_history.TraceStore') as MockStore:
        mock_store = MagicMock()
        mock_store.get_sessions.return_value = []
        MockStore.return_value = mock_store

        from src.agent.ui.task_history import TaskHistoryView
        view = TaskHistoryView(on_replay=MagicMock())
        view.refresh()

        mock_store.get_sessions.assert_called()

def test_task_session_row_display():
    """Test TaskSessionRow renders session."""
    from src.agent.ui.task_history import TaskSessionRow
    from src.agent.observability.trace_models import TraceSession

    session = TraceSession(
        id="test-session",
        task="Build a web scraper for news articles",
        started_at=datetime.now(timezone.utc),
        status="completed",
        total_events=15,
        total_tokens=5000,
        total_cost_usd=0.05,
    )
    row = TaskSessionRow(session, on_replay=MagicMock())
    assert row is not None

def test_replay_callback():
    """Test replay button triggers callback."""
    from src.agent.ui.task_history import TaskSessionRow
    from src.agent.observability.trace_models import TraceSession

    callback = MagicMock()
    session = TraceSession(
        id="test",
        task="Test task",
        started_at=datetime.now(timezone.utc),
        status="completed",
    )
    row = TaskSessionRow(session, on_replay=callback)

    # Simulate replay click
    row._on_replay_click(None)
    callback.assert_called_with("Test task")
```

Run: `python -m pytest tests/agent/ui/test_task_history.py -v`
  </action>
  <verify>pytest tests/agent/ui/test_task_history.py passes</verify>
  <done>TaskHistoryView exported and tested</done>
</task>

</tasks>

<verification>
- [ ] TaskHistoryView shows list of past sessions
- [ ] Status icon matches session status
- [ ] Task description truncated appropriately
- [ ] Replay button visible and clickable
- [ ] on_replay callback receives task description
- [ ] Empty state handled gracefully
- [ ] Pagination works for long history
</verification>

<success_criteria>
Task history shows past agent executions. Users can replay previous tasks with one click.
</success_criteria>

<output>
After completion, create `.planning/phases/12-ui-integration/12-06-SUMMARY.md`
</output>
