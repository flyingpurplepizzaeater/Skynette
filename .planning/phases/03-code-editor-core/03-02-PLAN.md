---
phase: 03-code-editor-core
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/ui/views/code_editor/__init__.py
  - src/ui/views/code_editor/state.py
  - src/ui/views/code_editor/editor.py
  - src/ui/components/code_editor/__init__.py
  - src/ui/components/code_editor/line_numbers.py
autonomous: true

must_haves:
  truths:
    - "Editor state tracks open files with dirty flags"
    - "Code displays with syntax highlighting"
    - "Line numbers appear in gutter alongside code"
    - "User can type in the editor and content updates"
  artifacts:
    - path: "src/ui/views/code_editor/state.py"
      provides: "EditorState dataclass with listener pattern"
      exports: ["EditorState", "OpenFile"]
    - path: "src/ui/views/code_editor/editor.py"
      provides: "CodeEditor component"
      exports: ["CodeEditor"]
    - path: "src/ui/components/code_editor/line_numbers.py"
      provides: "Line numbers gutter"
      exports: ["LineNumbers"]
  key_links:
    - from: "src/ui/views/code_editor/editor.py"
      to: "src/services/editor/highlighter.py"
      via: "import and call highlight()"
      pattern: "PygmentsHighlighter.*highlight"
    - from: "src/ui/views/code_editor/state.py"
      to: "listener pattern"
      via: "add_listener/notify methods"
      pattern: "_listeners.*notify"
---

<objective>
Create EditorState (centralized state) and CodeEditor component with syntax highlighting and line numbers.

Purpose: Establish the core editing experience - user can see highlighted code with line numbers and edit it. State management follows the established ai_hub pattern for consistency.

Output: Editable code component with syntax highlighting, line numbers gutter, and centralized state management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-editor-core/03-RESEARCH.md

# State pattern to follow
@src/ui/views/ai_hub/state.py

# Services from Plan 01
@src/services/editor/highlighter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EditorState with listener pattern</name>
  <files>
    - src/ui/views/code_editor/__init__.py
    - src/ui/views/code_editor/state.py
  </files>
  <action>
Create state container following AIHubState pattern from Phase 1.

1. Create `src/ui/views/code_editor/__init__.py` (placeholder, will be populated in Plan 04)
2. Create `src/ui/views/code_editor/state.py`:

```python
from dataclasses import dataclass, field
from collections.abc import Callable

@dataclass
class OpenFile:
    """Represents an open file in the editor."""
    path: str
    content: str
    language: str
    is_dirty: bool = False
    scroll_position: int = 0
    cursor_position: int = 0

@dataclass
class EditorState:
    """Centralized state for code editor components.

    Follows the listener/notify pattern from AIHubState.
    """

    open_files: list[OpenFile] = field(default_factory=list)
    active_file_index: int = -1
    file_tree_root: str | None = None
    sidebar_width: int = 250
    sidebar_visible: bool = True

    _listeners: list[Callable[[], None]] = field(default_factory=list, repr=False)

    def add_listener(self, callback: Callable[[], None]) -> None:
        """Register a callback for state changes."""

    def remove_listener(self, callback: Callable[[], None]) -> None:
        """Unregister a callback."""

    def notify(self) -> None:
        """Notify all listeners of state change."""

    @property
    def active_file(self) -> OpenFile | None:
        """Get currently active file."""

    def open_file(self, path: str, content: str, language: str) -> None:
        """Open file or focus if already open."""

    def close_file(self, index: int) -> bool:
        """Close file at index. Returns True if file was dirty (needs save prompt)."""

    def set_content(self, index: int, content: str) -> None:
        """Update file content and mark dirty."""

    def mark_saved(self, index: int) -> None:
        """Mark file as saved (clear dirty flag)."""

    def set_active(self, index: int) -> None:
        """Set active file by index."""

    def set_sidebar_width(self, width: int) -> None:
        """Update sidebar width."""

    def toggle_sidebar(self) -> None:
        """Toggle sidebar visibility."""

    def set_file_tree_root(self, path: str) -> None:
        """Set root path for file tree."""
```

Duplicate detection: If opening a file that's already open, just set it active.
Dirty tracking: Any content change sets is_dirty=True.
  </action>
  <verify>
```bash
python -c "
from src.ui.views.code_editor.state import EditorState, OpenFile
state = EditorState()
state.open_file('test.py', 'x = 1', 'python')
print(f'Files: {len(state.open_files)}, Active: {state.active_file_index}')
state.set_content(0, 'x = 2')
print(f'Dirty: {state.open_files[0].is_dirty}')
"
```
Should output "Files: 1, Active: 0" then "Dirty: True".
  </verify>
  <done>EditorState tracks open files, active file, dirty flags with listener pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create LineNumbers gutter component</name>
  <files>
    - src/ui/components/code_editor/__init__.py
    - src/ui/components/code_editor/line_numbers.py
  </files>
  <action>
Create line numbers gutter that syncs with editor content.

1. Create `src/ui/components/code_editor/__init__.py` with exports
2. Create `src/ui/components/code_editor/line_numbers.py`:

```python
import flet as ft
from src.ui.theme import SkynetteTheme

class LineNumbers(ft.UserControl):
    """Line number gutter for code editor.

    Displays line numbers that sync with the editor content.
    """

    def __init__(
        self,
        line_count: int = 1,
        current_line: int = 1,
        line_height: int = 20,
    ):
        super().__init__()
        self.line_count = line_count
        self.current_line = current_line
        self.line_height = line_height

    def build(self) -> ft.Control:
        """Build line numbers column."""
        # Calculate width based on max line number digits
        max_digits = len(str(self.line_count))
        width = max(30, max_digits * 10 + 16)

        numbers = []
        for i in range(1, self.line_count + 1):
            is_current = i == self.current_line
            numbers.append(
                ft.Text(
                    str(i),
                    size=13,
                    font_family="monospace",
                    color=SkynetteTheme.TEXT_PRIMARY if is_current else SkynetteTheme.TEXT_SECONDARY,
                    text_align=ft.TextAlign.RIGHT,
                )
            )

        return ft.Container(
            content=ft.Column(
                controls=numbers,
                spacing=0,
                scroll=ft.ScrollMode.HIDDEN,  # Synced externally
            ),
            width=width,
            padding=ft.padding.only(right=8),
            bgcolor=SkynetteTheme.BG_SECONDARY,
            border=ft.border.only(right=ft.BorderSide(1, SkynetteTheme.BORDER)),
        )

    def update_lines(self, line_count: int, current_line: int = 1) -> None:
        """Update line count and current line."""
        self.line_count = line_count
        self.current_line = current_line
        self.update()
```

Line height should match editor font metrics.
Current line is highlighted with brighter color.
Width auto-adjusts based on max line number digits.
  </action>
  <verify>
```bash
python -c "from src.ui.components.code_editor import LineNumbers; ln = LineNumbers(line_count=100); print(f'LineNumbers component created')"
```
Should output "LineNumbers component created".
  </verify>
  <done>LineNumbers gutter displays line numbers with current line highlighting</done>
</task>

<task type="auto">
  <name>Task 3: Create CodeEditor component with highlighting</name>
  <files>src/ui/views/code_editor/editor.py</files>
  <action>
Create the main code editor component combining TextField and syntax highlighting.

```python
import flet as ft
from src.ui.theme import SkynetteTheme
from src.services.editor import PygmentsHighlighter
from src.ui.components.code_editor import LineNumbers

class CodeEditor(ft.UserControl):
    """Code editor with syntax highlighting.

    Uses TextField for editing with syntax-highlighted overlay.
    Includes line numbers gutter.
    """

    def __init__(
        self,
        content: str = "",
        language: str = "text",
        on_change: Callable[[str], None] | None = None,
        read_only: bool = False,
    ):
        super().__init__()
        self.content = content
        self.language = language
        self.on_change = on_change
        self.read_only = read_only

        self.highlighter = PygmentsHighlighter()
        self._text_field: ft.TextField | None = None
        self._line_numbers: LineNumbers | None = None
        self._highlighted_text: ft.Text | None = None

    def build(self) -> ft.Control:
        """Build editor with line numbers and editing area."""
        line_count = self.content.count('\n') + 1
        self._line_numbers = LineNumbers(line_count=line_count)

        # TextField for actual editing (invisible text, captures input)
        self._text_field = ft.TextField(
            value=self.content,
            multiline=True,
            min_lines=20,
            expand=True,
            border=ft.InputBorder.NONE,
            bgcolor="transparent",
            color="transparent",  # Hide actual text
            cursor_color=SkynetteTheme.TEXT_PRIMARY,
            text_style=ft.TextStyle(
                font_family="monospace",
                size=13,
            ),
            on_change=self._handle_change,
            read_only=self.read_only,
        )

        # Highlighted text overlay (display only)
        spans = self.highlighter.highlight(self.content, self.language)
        self._highlighted_text = ft.Text(
            spans=spans,
            font_family="monospace",
            size=13,
            selectable=False,
        )

        # Stack TextField and highlighted text
        editor_stack = ft.Stack(
            controls=[
                # Highlighted text at bottom (display)
                ft.Container(
                    content=self._highlighted_text,
                    padding=ft.padding.all(8),
                ),
                # TextField on top (editing, transparent text)
                ft.Container(
                    content=self._text_field,
                    padding=ft.padding.all(8),
                ),
            ],
            expand=True,
        )

        return ft.Row(
            controls=[
                self._line_numbers,
                ft.Container(
                    content=editor_stack,
                    expand=True,
                    bgcolor=SkynetteTheme.BG_PRIMARY,
                ),
            ],
            spacing=0,
            expand=True,
        )

    def _handle_change(self, e: ft.ControlEvent) -> None:
        """Handle text changes - update highlighting and notify."""
        self.content = e.control.value
        line_count = self.content.count('\n') + 1
        self._line_numbers.update_lines(line_count)

        # Re-highlight
        spans = self.highlighter.highlight(self.content, self.language)
        self._highlighted_text.spans = spans
        self._highlighted_text.update()

        if self.on_change:
            self.on_change(self.content)

    def set_content(self, content: str, language: str | None = None) -> None:
        """Set editor content and optionally language."""
        self.content = content
        if language:
            self.language = language
        if self._text_field:
            self._text_field.value = content
            self._handle_change(None)  # Trigger re-highlight
            self.update()

    def get_content(self) -> str:
        """Get current editor content."""
        return self.content
```

The TextField is transparent but captures all keyboard input.
The highlighted Text renders below it.
This approach avoids cursor/selection sync issues from research.
  </action>
  <verify>
```bash
python -c "
from src.ui.views.code_editor.editor import CodeEditor
editor = CodeEditor(content='def foo():\\n    return 42', language='python')
print(f'CodeEditor created, content lines: {editor.content.count(chr(10)) + 1}')
"
```
Should output "CodeEditor created, content lines: 2".
  </verify>
  <done>CodeEditor component renders code with syntax highlighting and line numbers</done>
</task>

</tasks>

<verification>
Full component import test:
```bash
python -c "
from src.ui.views.code_editor.state import EditorState, OpenFile
from src.ui.views.code_editor.editor import CodeEditor
from src.ui.components.code_editor import LineNumbers
print('All editor components importable')
"
```

State integration:
```bash
python -c "
from src.ui.views.code_editor.state import EditorState
state = EditorState()
state.open_file('test.py', 'print(1)', 'python')
state.set_content(0, 'print(2)')
assert state.open_files[0].is_dirty == True
print('State dirty tracking works')
"
```
</verification>

<success_criteria>
- EditorState follows listener/notify pattern from ai_hub
- OpenFile tracks path, content, language, dirty flag
- LineNumbers displays line numbers with current line highlight
- CodeEditor shows syntax-highlighted code with editing capability
- All components integrate with highlighter service from Plan 01
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-editor-core/03-02-SUMMARY.md`
</output>
