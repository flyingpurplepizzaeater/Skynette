---
phase: 03-code-editor-core
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/ui/views/code_editor/tab_bar.py
  - src/ui/views/code_editor/toolbar.py
  - src/ui/views/code_editor/__init__.py
  - src/ui/app.py
autonomous: false

must_haves:
  truths:
    - "User can see tabs for each open file"
    - "Clicking tab switches to that file"
    - "Close button removes tab (with save prompt if dirty)"
    - "User can navigate to Code Editor from sidebar"
    - "Toolbar has save, save all, toggle sidebar buttons"
  artifacts:
    - path: "src/ui/views/code_editor/tab_bar.py"
      provides: "EditorTabBar component"
      exports: ["EditorTabBar"]
    - path: "src/ui/views/code_editor/toolbar.py"
      provides: "EditorToolbar component"
      exports: ["EditorToolbar"]
    - path: "src/ui/views/code_editor/__init__.py"
      provides: "CodeEditorView main view"
      exports: ["CodeEditorView"]
  key_links:
    - from: "src/ui/views/code_editor/__init__.py"
      to: "src/ui/views/code_editor/state.py"
      via: "EditorState usage"
      pattern: "EditorState"
    - from: "src/ui/views/code_editor/__init__.py"
      to: "src/ui/views/code_editor/editor.py"
      via: "CodeEditor component"
      pattern: "CodeEditor"
    - from: "src/ui/app.py"
      to: "src/ui/views/code_editor/__init__.py"
      via: "navigation integration"
      pattern: "CodeEditorView"
---

<objective>
Create tab bar, toolbar, and assemble CodeEditorView with navigation integration.

Purpose: Complete the editor experience by adding tabbed interface for multiple files, toolbar for common actions, and integrating with main app navigation. This plan connects all prior components into a usable view.

Output: Fully functional code editor accessible from main sidebar navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-editor-core/03-RESEARCH.md
@.planning/phases/03-code-editor-core/03-01-SUMMARY.md
@.planning/phases/03-code-editor-core/03-02-SUMMARY.md
@.planning/phases/03-code-editor-core/03-03-SUMMARY.md

# Components from Plans 02 and 03
@src/ui/views/code_editor/state.py
@src/ui/views/code_editor/editor.py
@src/ui/views/code_editor/file_tree.py
@src/ui/components/code_editor/resizable_panel.py

# App integration
@src/ui/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EditorTabBar component</name>
  <files>src/ui/views/code_editor/tab_bar.py</files>
  <action>
Create tab bar with close buttons, dirty indicators, and reordering.

```python
import flet as ft
from collections.abc import Callable
from src.ui.theme import SkynetteTheme
from src.ui.views.code_editor.state import OpenFile

class EditorTabBar(ft.UserControl):
    """Tab bar for open files.

    Features:
    - Close button (X) on each tab
    - Dirty indicator (dot) for unsaved changes
    - Click to switch tabs
    - Horizontal scroll when many tabs
    - Right-click context menu (Close All, Close Others)
    """

    def __init__(
        self,
        files: list[OpenFile],
        active_index: int,
        on_select: Callable[[int], None],
        on_close: Callable[[int], None],
        on_close_all: Callable[[], None] | None = None,
        on_close_others: Callable[[int], None] | None = None,
    ):
        super().__init__()
        self.files = files
        self.active_index = active_index
        self.on_select = on_select
        self.on_close = on_close
        self.on_close_all = on_close_all
        self.on_close_others = on_close_others

    def build(self) -> ft.Control:
        """Build scrollable tab bar."""
        tabs = [self._build_tab(i, f) for i, f in enumerate(self.files)]

        return ft.Container(
            content=ft.Row(
                controls=tabs,
                scroll=ft.ScrollMode.AUTO,
                spacing=0,
            ),
            height=36,
            bgcolor=SkynetteTheme.BG_SECONDARY,
            border=ft.border.only(bottom=ft.BorderSide(1, SkynetteTheme.BORDER)),
        )

    def _build_tab(self, index: int, file: OpenFile) -> ft.Control:
        """Build single tab with close button and dirty indicator."""
        is_active = index == self.active_index
        filename = file.path.split('/')[-1].split('\\')[-1]  # Cross-platform

        # Dirty indicator (dot before filename)
        dirty_indicator = ft.Text(
            " * " if file.is_dirty else "",
            size=13,
            color=SkynetteTheme.WARNING if file.is_dirty else "transparent",
        )

        # Close button
        close_btn = ft.IconButton(
            icon=ft.Icons.CLOSE,
            icon_size=14,
            tooltip="Close",
            on_click=lambda e, i=index: self._handle_close(i),
            style=ft.ButtonStyle(
                padding=ft.padding.all(4),
            ),
        )

        tab = ft.Container(
            content=ft.Row(
                controls=[
                    dirty_indicator,
                    ft.Text(
                        filename,
                        size=13,
                        color=SkynetteTheme.TEXT_PRIMARY if is_active else SkynetteTheme.TEXT_SECONDARY,
                    ),
                    close_btn,
                ],
                spacing=4,
                alignment=ft.MainAxisAlignment.CENTER,
            ),
            padding=ft.padding.only(left=12, right=4, top=6, bottom=6),
            bgcolor=SkynetteTheme.BG_PRIMARY if is_active else SkynetteTheme.BG_SECONDARY,
            border=ft.border.only(
                bottom=ft.BorderSide(2, SkynetteTheme.PRIMARY) if is_active else None,
                right=ft.BorderSide(1, SkynetteTheme.BORDER),
            ),
            on_click=lambda e, i=index: self._handle_select(i),
            on_long_press=lambda e, i=index: self._show_context_menu(e, i),
        )

        return tab

    def _handle_select(self, index: int) -> None:
        """Handle tab selection."""
        self.on_select(index)

    def _handle_close(self, index: int) -> None:
        """Handle tab close button click."""
        self.on_close(index)

    def _show_context_menu(self, e: ft.ControlEvent, index: int) -> None:
        """Show context menu on right-click/long-press."""
        # Context menu implementation using PopupMenuButton
        # (Would need page reference for positioning - simplified here)
        pass

    def update_tabs(self, files: list[OpenFile], active_index: int) -> None:
        """Update tabs with new file list and active index."""
        self.files = files
        self.active_index = active_index
        self.update()
```

Dirty indicator shows asterisk/dot before filename.
Close button on each tab.
Active tab has bottom border highlight.
Horizontal scroll for many tabs.
  </action>
  <verify>
```bash
python -c "
from src.ui.views.code_editor.tab_bar import EditorTabBar
from src.ui.views.code_editor.state import OpenFile
files = [OpenFile(path='test.py', content='', language='python', is_dirty=True)]
tabs = EditorTabBar(files=files, active_index=0, on_select=lambda i: None, on_close=lambda i: None)
print('EditorTabBar created')
"
```
Should output "EditorTabBar created".
  </verify>
  <done>EditorTabBar shows tabs with dirty indicators and close buttons</done>
</task>

<task type="auto">
  <name>Task 2: Create EditorToolbar component</name>
  <files>src/ui/views/code_editor/toolbar.py</files>
  <action>
Create toolbar with save, save all, toggle sidebar, and open folder buttons.

```python
import flet as ft
from collections.abc import Callable
from src.ui.theme import SkynetteTheme

class EditorToolbar(ft.UserControl):
    """Toolbar for code editor actions.

    Actions: Save, Save All, Toggle Sidebar, Open Folder
    """

    def __init__(
        self,
        on_save: Callable[[], None],
        on_save_all: Callable[[], None],
        on_toggle_sidebar: Callable[[], None],
        on_open_folder: Callable[[], None],
        sidebar_visible: bool = True,
        has_unsaved: bool = False,
    ):
        super().__init__()
        self.on_save = on_save
        self.on_save_all = on_save_all
        self.on_toggle_sidebar = on_toggle_sidebar
        self.on_open_folder = on_open_folder
        self.sidebar_visible = sidebar_visible
        self.has_unsaved = has_unsaved

    def build(self) -> ft.Control:
        """Build toolbar row."""
        return ft.Container(
            content=ft.Row(
                controls=[
                    # Toggle sidebar
                    ft.IconButton(
                        icon=ft.Icons.MENU_OPEN if self.sidebar_visible else ft.Icons.MENU,
                        tooltip="Toggle Sidebar",
                        on_click=lambda e: self.on_toggle_sidebar(),
                    ),
                    ft.VerticalDivider(width=1),
                    # Open folder
                    ft.IconButton(
                        icon=ft.Icons.FOLDER_OPEN,
                        tooltip="Open Folder",
                        on_click=lambda e: self.on_open_folder(),
                    ),
                    ft.Container(expand=True),  # Spacer
                    # Save
                    ft.IconButton(
                        icon=ft.Icons.SAVE,
                        tooltip="Save (Ctrl+S)",
                        on_click=lambda e: self.on_save(),
                    ),
                    # Save All
                    ft.IconButton(
                        icon=ft.Icons.SAVE_ALT,
                        tooltip="Save All",
                        on_click=lambda e: self.on_save_all(),
                        icon_color=SkynetteTheme.WARNING if self.has_unsaved else None,
                    ),
                ],
                alignment=ft.MainAxisAlignment.START,
            ),
            height=40,
            padding=ft.padding.symmetric(horizontal=8),
            bgcolor=SkynetteTheme.BG_SECONDARY,
            border=ft.border.only(bottom=ft.BorderSide(1, SkynetteTheme.BORDER)),
        )

    def update_state(self, sidebar_visible: bool, has_unsaved: bool) -> None:
        """Update toolbar button states."""
        self.sidebar_visible = sidebar_visible
        self.has_unsaved = has_unsaved
        self.update()
```

Save All icon highlights if there are unsaved files.
Toggle sidebar button changes icon based on visibility.
  </action>
  <verify>
```bash
python -c "
from src.ui.views.code_editor.toolbar import EditorToolbar
toolbar = EditorToolbar(
    on_save=lambda: None,
    on_save_all=lambda: None,
    on_toggle_sidebar=lambda: None,
    on_open_folder=lambda: None,
)
print('EditorToolbar created')
"
```
Should output "EditorToolbar created".
  </verify>
  <done>EditorToolbar provides save, save all, toggle sidebar, open folder buttons</done>
</task>

<task type="auto">
  <name>Task 3: Assemble CodeEditorView and integrate with app navigation</name>
  <files>
    - src/ui/views/code_editor/__init__.py
    - src/ui/app.py
  </files>
  <action>
Assemble all components into CodeEditorView and add navigation in app.py.

**1. Create `src/ui/views/code_editor/__init__.py`:**

```python
import flet as ft
import asyncio
from src.ui.theme import SkynetteTheme
from src.ui.views.code_editor.state import EditorState
from src.ui.views.code_editor.editor import CodeEditor
from src.ui.views.code_editor.file_tree import FileTree
from src.ui.views.code_editor.tab_bar import EditorTabBar
from src.ui.views.code_editor.toolbar import EditorToolbar
from src.ui.components.code_editor import ResizableSplitPanel
from src.services.editor import FileService, PygmentsHighlighter

class CodeEditorView(ft.UserControl):
    """Main code editor view.

    Layout:
    - Toolbar at top
    - Resizable split: File tree | Editor area
    - Tab bar above editor
    - Editor content below tabs
    """

    def __init__(self, page: ft.Page):
        super().__init__()
        self.page = page
        self.state = EditorState()
        self.file_service = FileService()
        self.highlighter = PygmentsHighlighter()

        # Component references
        self._toolbar: EditorToolbar | None = None
        self._tab_bar: EditorTabBar | None = None
        self._file_tree: FileTree | None = None
        self._editor: CodeEditor | None = None
        self._split_panel: ResizableSplitPanel | None = None

        # Register state listener
        self.state.add_listener(self._on_state_change)

    def build(self) -> ft.Control:
        """Build the complete editor layout."""
        # Toolbar
        self._toolbar = EditorToolbar(
            on_save=self._save_current,
            on_save_all=self._save_all,
            on_toggle_sidebar=self._toggle_sidebar,
            on_open_folder=self._open_folder,
            sidebar_visible=self.state.sidebar_visible,
        )

        # File tree (with placeholder root)
        self._file_tree = FileTree(
            root_path=self.state.file_tree_root or ".",
            on_file_select=self._on_file_select,
        )

        # Tab bar
        self._tab_bar = EditorTabBar(
            files=self.state.open_files,
            active_index=self.state.active_file_index,
            on_select=self._on_tab_select,
            on_close=self._on_tab_close,
        )

        # Editor (placeholder when no file open)
        editor_content = self._build_editor_content()

        # Editor area (tabs + editor)
        editor_area = ft.Column(
            controls=[
                self._tab_bar,
                editor_content,
            ],
            expand=True,
            spacing=0,
        )

        # Split panel
        self._split_panel = ResizableSplitPanel(
            left=self._file_tree,
            right=editor_area,
            initial_width=self.state.sidebar_width,
            on_resize=self._on_sidebar_resize,
        )

        return ft.Column(
            controls=[
                self._toolbar,
                self._split_panel,
            ],
            expand=True,
            spacing=0,
        )

    def _build_editor_content(self) -> ft.Control:
        """Build editor content based on active file."""
        if self.state.active_file is None:
            # No file open - show placeholder
            return ft.Container(
                content=ft.Column(
                    controls=[
                        ft.Icon(ft.Icons.CODE, size=64, color=SkynetteTheme.TEXT_SECONDARY),
                        ft.Text(
                            "No file open",
                            size=16,
                            color=SkynetteTheme.TEXT_SECONDARY,
                        ),
                        ft.Text(
                            "Open a folder and select a file from the tree",
                            size=13,
                            color=SkynetteTheme.TEXT_SECONDARY,
                        ),
                    ],
                    horizontal_alignment=ft.CrossAxisAlignment.CENTER,
                    alignment=ft.MainAxisAlignment.CENTER,
                ),
                expand=True,
                alignment=ft.alignment.center,
            )

        # Create editor for active file
        active = self.state.active_file
        self._editor = CodeEditor(
            content=active.content,
            language=active.language,
            on_change=self._on_content_change,
        )
        return self._editor

    # Event handlers
    async def _on_file_select(self, path: str) -> None:
        """Handle file selection from tree."""
        try:
            content = await self.file_service.read_file(path)
            language = self.highlighter.get_language_from_filename(path)
            self.state.open_file(path, content, language)
        except ValueError as e:
            # File too large
            self._show_error(str(e))
        except Exception as e:
            self._show_error(f"Failed to open file: {e}")

    def _on_tab_select(self, index: int) -> None:
        """Handle tab selection."""
        self.state.set_active(index)

    def _on_tab_close(self, index: int) -> None:
        """Handle tab close - prompt if dirty."""
        file = self.state.open_files[index]
        if file.is_dirty:
            self._show_save_dialog(index)
        else:
            self.state.close_file(index)

    def _on_content_change(self, content: str) -> None:
        """Handle editor content change."""
        if self.state.active_file_index >= 0:
            self.state.set_content(self.state.active_file_index, content)

    def _on_sidebar_resize(self, width: int) -> None:
        """Handle sidebar resize."""
        self.state.set_sidebar_width(width)

    def _on_state_change(self) -> None:
        """Handle state changes - rebuild UI."""
        self.update()

    # Actions
    async def _save_current(self) -> None:
        """Save current file."""
        if self.state.active_file:
            f = self.state.active_file
            try:
                await self.file_service.write_file(f.path, f.content)
                self.state.mark_saved(self.state.active_file_index)
            except Exception as e:
                self._show_error(f"Save failed: {e}")

    async def _save_all(self) -> None:
        """Save all dirty files."""
        for i, f in enumerate(self.state.open_files):
            if f.is_dirty:
                try:
                    await self.file_service.write_file(f.path, f.content)
                    self.state.mark_saved(i)
                except Exception as e:
                    self._show_error(f"Failed to save {f.path}: {e}")

    def _toggle_sidebar(self) -> None:
        """Toggle sidebar visibility."""
        self.state.toggle_sidebar()
        self._split_panel.set_left_visible(self.state.sidebar_visible)

    async def _open_folder(self) -> None:
        """Open folder picker."""
        picker = ft.FilePicker(on_result=self._on_folder_picked)
        self.page.overlay.append(picker)
        self.page.update()
        picker.get_directory_path()

    def _on_folder_picked(self, e: ft.FilePickerResultEvent) -> None:
        """Handle folder picker result."""
        if e.path:
            self.state.set_file_tree_root(e.path)
            self._file_tree.set_root(e.path)

    def _show_save_dialog(self, index: int) -> None:
        """Show save/discard/cancel dialog for dirty file."""
        file = self.state.open_files[index]
        filename = file.path.split('/')[-1].split('\\')[-1]

        def handle_save(e):
            asyncio.create_task(self._save_and_close(index))
            dialog.open = False
            self.page.update()

        def handle_discard(e):
            self.state.close_file(index)
            dialog.open = False
            self.page.update()

        def handle_cancel(e):
            dialog.open = False
            self.page.update()

        dialog = ft.AlertDialog(
            title=ft.Text(f"Save changes to {filename}?"),
            content=ft.Text("Your changes will be lost if you don't save them."),
            actions=[
                ft.TextButton("Save", on_click=handle_save),
                ft.TextButton("Don't Save", on_click=handle_discard),
                ft.TextButton("Cancel", on_click=handle_cancel),
            ],
        )
        self.page.overlay.append(dialog)
        dialog.open = True
        self.page.update()

    async def _save_and_close(self, index: int) -> None:
        """Save file then close tab."""
        f = self.state.open_files[index]
        await self.file_service.write_file(f.path, f.content)
        self.state.close_file(index)

    def _show_error(self, message: str) -> None:
        """Show error snackbar."""
        self.page.snack_bar = ft.SnackBar(
            content=ft.Text(message),
            bgcolor=SkynetteTheme.ERROR,
        )
        self.page.snack_bar.open = True
        self.page.update()

    def dispose(self) -> None:
        """Clean up resources."""
        self.state.remove_listener(self._on_state_change)
```

**2. Update `src/ui/app.py` to add navigation:**

Add import at top:
```python
from src.ui.views.code_editor import CodeEditorView
```

Add navigation item in `_build_sidebar()` method (find the navigation items section):
```python
# Add to nav_items list (after existing items like "workflows", "agents", etc.)
{
    "icon": ft.Icons.CODE,
    "label": "Code Editor",
    "view": "code_editor",
},
```

Add view creation in `_navigate_to()` method:
```python
elif view == "code_editor":
    self.content_area.content = CodeEditorView(self.page)
```

Add view title in `view_titles` dict:
```python
"code_editor": "Code Editor",
```
  </action>
  <verify>
```bash
python -c "
from src.ui.views.code_editor import CodeEditorView
print('CodeEditorView importable')
"
```
Should output "CodeEditorView importable".

Check app.py has the import:
```bash
grep -n "CodeEditorView" src/ui/app.py
```
Should show import line and usage.
  </verify>
  <done>CodeEditorView assembled with all components and accessible from main navigation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete code editor view with file tree, tabs, toolbar, and syntax highlighting</what-built>
  <how-to-verify>
1. Launch the app: `python -m src.main`
2. Click "Code Editor" in the left sidebar
3. Click "Open Folder" button and select a project folder (e.g., the skynette-repo itself)
4. Verify file tree shows directories and files
5. Click on a .py file - should open in editor with syntax highlighting
6. Click on another file - should open in new tab
7. Make an edit - should see dirty indicator (asterisk) on tab
8. Click save button - dirty indicator should disappear
9. Drag the sidebar divider - should resize
10. Click toggle sidebar button - sidebar should hide/show
  </how-to-verify>
  <resume-signal>Type "approved" if editor is functional, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
All components import:
```bash
python -c "
from src.ui.views.code_editor import CodeEditorView
from src.ui.views.code_editor.tab_bar import EditorTabBar
from src.ui.views.code_editor.toolbar import EditorToolbar
print('All view components importable')
"
```

App has navigation:
```bash
grep "code_editor" src/ui/app.py
```
Should find navigation entry.
</verification>

<success_criteria>
- EditorTabBar shows tabs with close buttons and dirty indicators
- EditorToolbar has save, save all, toggle sidebar, open folder
- CodeEditorView assembles all components into VS Code-like layout
- Navigation from main sidebar to code editor works
- File tree shows directory contents
- Opening files shows syntax-highlighted content in tabs
- Dirty tracking and save prompts work
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-editor-core/03-04-SUMMARY.md`
</output>
