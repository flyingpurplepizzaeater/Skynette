---
phase: 03-code-editor-core
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/ui/views/code_editor/file_tree.py
  - src/ui/components/code_editor/resizable_panel.py
autonomous: true

must_haves:
  truths:
    - "User can see directory contents as a tree"
    - "Clicking a file triggers file open callback"
    - "Clicking a folder expands/collapses its children"
    - "Sidebar can be resized by dragging divider"
  artifacts:
    - path: "src/ui/views/code_editor/file_tree.py"
      provides: "FileTree component"
      exports: ["FileTree"]
    - path: "src/ui/components/code_editor/resizable_panel.py"
      provides: "ResizableSplitPanel component"
      exports: ["ResizableSplitPanel"]
  key_links:
    - from: "src/ui/views/code_editor/file_tree.py"
      to: "src/services/editor/file_service.py"
      via: "list_directory for contents"
      pattern: "FileService.*list_directory"
    - from: "src/ui/views/code_editor/file_tree.py"
      to: "src/services/editor/file_icons.py"
      via: "get_file_icon for icons"
      pattern: "get_file_icon"
    - from: "src/ui/components/code_editor/resizable_panel.py"
      to: "GestureDetector"
      via: "horizontal drag events"
      pattern: "on_horizontal_drag"
---

<objective>
Create FileTree component for directory browsing and ResizableSplitPanel for adjustable sidebar.

Purpose: Enable users to navigate project files visually and resize the file tree sidebar. The FileTree uses ListView with lazy loading for performance with large projects.

Output: FileTree component with expand/collapse and file selection, plus ResizableSplitPanel for layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-editor-core/03-RESEARCH.md

# Services from Plan 01
@src/services/editor/file_service.py
@src/services/editor/file_icons.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FileTree component</name>
  <files>src/ui/views/code_editor/file_tree.py</files>
  <action>
Create file tree using ListView with lazy loading on expand.

```python
import flet as ft
from pathlib import Path
from collections.abc import Callable
from dataclasses import dataclass
from src.ui.theme import SkynetteTheme
from src.services.editor import FileService, get_file_icon

@dataclass
class FileTreeItem:
    """Represents a file or folder in the tree."""
    path: Path
    level: int
    is_expanded: bool = False

    @property
    def is_dir(self) -> bool:
        return self.path.is_dir()

    @property
    def name(self) -> str:
        return self.path.name

class FileTree(ft.UserControl):
    """File tree navigator with lazy loading.

    - Single click on folder: expand/collapse
    - Single click on file: trigger on_file_select callback
    - Lazy loads subdirectories on expand for performance
    """

    def __init__(
        self,
        root_path: str,
        on_file_select: Callable[[str], None],
        filter_text: str = "",
    ):
        super().__init__()
        self.root = Path(root_path)
        self.on_file_select = on_file_select
        self.filter_text = filter_text.lower()

        self.file_service = FileService()
        self.items: list[FileTreeItem] = []
        self.expanded_paths: set[str] = set()

    def build(self) -> ft.Control:
        """Build file tree with filter input and list."""
        self._load_directory(self.root, level=0)

        # Filter input
        filter_input = ft.TextField(
            hint_text="Filter files...",
            prefix_icon=ft.Icons.SEARCH,
            border_radius=4,
            height=36,
            text_size=13,
            on_change=self._handle_filter_change,
        )

        # File list
        list_view = ft.ListView(
            controls=[self._build_item(item) for item in self.items],
            expand=True,
            spacing=0,
            item_extent=28,  # Fixed height for virtualization
        )

        return ft.Column(
            controls=[
                ft.Container(
                    content=filter_input,
                    padding=ft.padding.all(8),
                ),
                ft.Container(
                    content=list_view,
                    expand=True,
                ),
            ],
            expand=True,
            spacing=0,
        )

    def _load_directory(self, path: Path, level: int) -> None:
        """Load directory contents at given level."""
        try:
            entries = self.file_service.list_directory(str(path))
            for entry in entries:
                entry_path = Path(entry.path)

                # Apply filter
                if self.filter_text and self.filter_text not in entry.name.lower():
                    if not entry.is_dir:  # Skip non-matching files
                        continue

                item = FileTreeItem(path=entry_path, level=level)
                self.items.append(item)

                # If directory is expanded, load children
                if entry.is_dir and str(entry_path) in self.expanded_paths:
                    item.is_expanded = True
                    self._load_directory(entry_path, level + 1)
        except PermissionError:
            pass  # Skip directories we can't access

    def _build_item(self, item: FileTreeItem) -> ft.Control:
        """Build a single tree item row."""
        indent = item.level * 16 + 8
        icon = get_file_icon(item.name, item.is_dir, item.is_expanded)

        # Expand/collapse indicator for folders
        expand_icon = None
        if item.is_dir:
            expand_icon = ft.Icon(
                ft.Icons.KEYBOARD_ARROW_DOWN if item.is_expanded else ft.Icons.KEYBOARD_ARROW_RIGHT,
                size=16,
                color=SkynetteTheme.TEXT_SECONDARY,
            )

        return ft.Container(
            content=ft.Row(
                controls=[
                    *([] if not expand_icon else [expand_icon]),
                    ft.Icon(icon, size=16, color=SkynetteTheme.TEXT_SECONDARY),
                    ft.Text(
                        item.name,
                        size=13,
                        color=SkynetteTheme.TEXT_PRIMARY,
                        overflow=ft.TextOverflow.ELLIPSIS,
                    ),
                ],
                spacing=4,
            ),
            padding=ft.padding.only(left=indent, top=4, bottom=4, right=8),
            on_click=lambda e, i=item: self._handle_click(i),
            on_hover=self._handle_hover,
            border_radius=4,
        )

    def _handle_click(self, item: FileTreeItem) -> None:
        """Handle click on tree item."""
        if item.is_dir:
            # Toggle expand/collapse
            path_str = str(item.path)
            if path_str in self.expanded_paths:
                self.expanded_paths.remove(path_str)
            else:
                self.expanded_paths.add(path_str)
            self._rebuild()
        else:
            # Select file
            self.on_file_select(str(item.path))

    def _handle_hover(self, e: ft.ControlEvent) -> None:
        """Highlight on hover."""
        e.control.bgcolor = SkynetteTheme.BG_SECONDARY if e.data == "true" else None
        e.control.update()

    def _handle_filter_change(self, e: ft.ControlEvent) -> None:
        """Handle filter text change."""
        self.filter_text = e.control.value.lower()
        self._rebuild()

    def _rebuild(self) -> None:
        """Rebuild tree with current expanded state and filter."""
        self.items.clear()
        self._load_directory(self.root, level=0)
        self.update()

    def set_root(self, path: str) -> None:
        """Change root directory."""
        self.root = Path(path)
        self.expanded_paths.clear()
        self._rebuild()

    def refresh(self) -> None:
        """Refresh current tree (e.g., after file creation)."""
        self._rebuild()
```

Lazy loading: Only load children when folder is expanded.
Filter: Only show files matching filter text.
item_extent=28 enables ListView virtualization.
  </action>
  <verify>
```bash
python -c "
from src.ui.views.code_editor.file_tree import FileTree
def on_select(path): print(f'Selected: {path}')
tree = FileTree(root_path='.', on_file_select=on_select)
print(f'FileTree created with root: {tree.root}')
"
```
Should output "FileTree created with root: .".
  </verify>
  <done>FileTree shows directories with expand/collapse and file selection</done>
</task>

<task type="auto">
  <name>Task 2: Create ResizableSplitPanel component</name>
  <files>src/ui/components/code_editor/resizable_panel.py</files>
  <action>
Create resizable two-panel layout using GestureDetector.

```python
import flet as ft
from collections.abc import Callable
from src.ui.theme import SkynetteTheme

class ResizableSplitPanel(ft.UserControl):
    """Two-panel layout with draggable divider.

    Left panel has fixed width, right panel expands.
    Divider can be dragged to resize.
    """

    MIN_WIDTH = 150
    MAX_WIDTH = 500

    def __init__(
        self,
        left: ft.Control,
        right: ft.Control,
        initial_width: int = 250,
        on_resize: Callable[[int], None] | None = None,
    ):
        super().__init__()
        self.left_panel = left
        self.right_panel = right
        self.left_width = initial_width
        self.on_resize = on_resize

        self._left_container: ft.Container | None = None

    def build(self) -> ft.Control:
        """Build split panel with draggable divider."""
        # Divider with drag handling
        divider = ft.GestureDetector(
            content=ft.Container(
                width=4,
                bgcolor=SkynetteTheme.BORDER,
            ),
            on_horizontal_drag_start=self._on_drag_start,
            on_horizontal_drag_update=self._on_drag_update,
            mouse_cursor=ft.MouseCursor.RESIZE_LEFT_RIGHT,
        )

        self._left_container = ft.Container(
            content=self.left_panel,
            width=self.left_width,
            bgcolor=SkynetteTheme.BG_SECONDARY,
        )

        return ft.Row(
            controls=[
                self._left_container,
                divider,
                ft.Container(
                    content=self.right_panel,
                    expand=True,
                    bgcolor=SkynetteTheme.BG_PRIMARY,
                ),
            ],
            expand=True,
            spacing=0,
        )

    def _on_drag_start(self, e: ft.DragStartEvent) -> None:
        """Capture initial state on drag start."""
        pass  # Could add visual feedback here

    def _on_drag_update(self, e: ft.DragUpdateEvent) -> None:
        """Handle drag to resize."""
        new_width = self.left_width + e.delta_x
        new_width = max(self.MIN_WIDTH, min(self.MAX_WIDTH, new_width))

        if new_width != self.left_width:
            self.left_width = int(new_width)
            self._left_container.width = self.left_width
            self._left_container.update()

            if self.on_resize:
                self.on_resize(self.left_width)

    def set_left_width(self, width: int) -> None:
        """Programmatically set left panel width."""
        self.left_width = max(self.MIN_WIDTH, min(self.MAX_WIDTH, width))
        if self._left_container:
            self._left_container.width = self.left_width
            self._left_container.update()

    def set_left_visible(self, visible: bool) -> None:
        """Show/hide left panel."""
        if self._left_container:
            self._left_container.visible = visible
            self._left_container.update()
```

GestureDetector captures horizontal drags.
MIN_WIDTH and MAX_WIDTH constrain panel size.
on_resize callback allows state sync (for persistence).
  </action>
  <verify>
```bash
python -c "
import flet as ft
from src.ui.components.code_editor.resizable_panel import ResizableSplitPanel
left = ft.Container(width=200, bgcolor='red')
right = ft.Container(expand=True, bgcolor='blue')
panel = ResizableSplitPanel(left=left, right=right, initial_width=250)
print(f'ResizableSplitPanel created with width: {panel.left_width}')
"
```
Should output "ResizableSplitPanel created with width: 250".
  </verify>
  <done>ResizableSplitPanel allows dragging to resize left/right panels</done>
</task>

</tasks>

<verification>
FileTree loads directory:
```bash
python -c "
from src.ui.views.code_editor.file_tree import FileTree
tree = FileTree(root_path='src', on_file_select=lambda p: print(p))
print(f'Items loaded: {len(tree.items)}')
"
```
Should output "Items loaded: N" where N > 0.

All components importable:
```bash
python -c "
from src.ui.views.code_editor.file_tree import FileTree
from src.ui.components.code_editor.resizable_panel import ResizableSplitPanel
print('FileTree and ResizableSplitPanel importable')
"
```
</verification>

<success_criteria>
- FileTree displays directory contents as indented list
- Single-click expands/collapses folders
- Single-click on file triggers callback with path
- Filter input narrows visible files
- ResizableSplitPanel has draggable divider
- Divider respects min/max width constraints
- Both components use SkynetteTheme colors
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-editor-core/03-03-SUMMARY.md`
</output>
