---
phase: 10-built-in-tools
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/agent/tools/filesystem.py
  - src/agent/tools/__init__.py
  - src/agent/registry/tool_registry.py
autonomous: true

must_haves:
  truths:
    - "Agent can read files in allowed directories (TOOL-03)"
    - "Agent can write files with automatic backup (TOOL-03)"
    - "Agent can delete files with backup preservation (TOOL-03)"
    - "Files in blocked patterns cannot be read, written, or deleted"
    - "Files outside allowed directories are rejected"
  artifacts:
    - path: "src/agent/tools/filesystem.py"
      provides: "FileReadTool, FileWriteTool, FileDeleteTool, FileListTool"
      exports: ["FileReadTool", "FileWriteTool", "FileDeleteTool", "FileListTool"]
    - path: "src/agent/registry/tool_registry.py"
      provides: "Filesystem tools registration"
      contains: "FileReadTool"
  key_links:
    - from: "src/agent/tools/filesystem.py"
      to: "src/agent/tools/base.py"
      via: "FileSystemValidator import"
      pattern: "from src.agent.tools.base import FileSystemValidator"
    - from: "FileWriteTool.execute"
      to: "backup_before_modify"
      via: "backup call before write"
      pattern: "backup_before_modify"
    - from: "FileDeleteTool.execute"
      to: "backup_before_modify"
      via: "backup call before delete"
      pattern: "backup_before_modify"
---

<objective>
Implement filesystem tools (read, write, delete, list) with security validation and automatic backup.

Purpose: Enables agent to interact with files - essential for coding tasks, data processing, and file management. Satisfies TOOL-03.

Output: FileReadTool, FileWriteTool, FileDeleteTool, FileListTool registered in ToolRegistry.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-built-in-tools/10-CONTEXT.md
@.planning/phases/10-built-in-tools/10-RESEARCH.md

# Foundation from Plan 01
@src/agent/tools/base.py (FileSystemValidator, backup_before_modify, cleanup_old_backups)

# Tool patterns
@src/agent/registry/base_tool.py
@src/agent/models/tool.py

# Existing file node patterns
@src/core/nodes/data/read_file.py
@src/core/nodes/data/write_file.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement filesystem tools</name>
  <files>
    src/agent/tools/filesystem.py
  </files>
  <action>
Create `src/agent/tools/filesystem.py` with four tools:

**Configuration (module-level):**
- DEFAULT_ALLOWED_PATHS: Start with user's home directory and current working directory
- DEFAULT_BLOCKED_PATTERNS: [".env", "credentials", ".git/config", "id_rsa", ".ssh/", ".aws/"]
- MAX_FILE_SIZE: 50 * 1024 * 1024  # 50 MB per CONTEXT.md

**Shared helper:**
```python
def _get_validator() -> FileSystemValidator:
    """Get validator with default paths. Can be overridden via config."""
    # TODO: Load from user settings in future
    return FileSystemValidator(
        allowed_paths=[str(Path.home()), str(Path.cwd())],
        blocked_patterns=DEFAULT_BLOCKED_PATTERNS,
    )
```

**1. FileReadTool:**
```python
name = "file_read"
description = "Read contents of a file. Respects allowed directories and blocked patterns."
parameters_schema = {
    "type": "object",
    "properties": {
        "path": {"type": "string", "description": "Absolute path to file"},
        "encoding": {"type": "string", "description": "Text encoding (default: utf-8)", "default": "utf-8"}
    },
    "required": ["path"]
}
```
Execute:
- Validate path with FileSystemValidator
- Check file size against MAX_FILE_SIZE
- Read file content (detect binary vs text based on extension)
- Return {content, path, size, encoding}

**2. FileWriteTool:**
```python
name = "file_write"
description = "Write content to a file. Creates backup before overwriting. Creates directories as needed."
parameters_schema = {
    "type": "object",
    "properties": {
        "path": {"type": "string", "description": "Absolute path to file"},
        "content": {"type": "string", "description": "Content to write"},
        "encoding": {"type": "string", "default": "utf-8"},
        "append": {"type": "boolean", "description": "Append instead of overwrite", "default": False}
    },
    "required": ["path", "content"]
}
is_destructive = True  # Mark as destructive for Phase 11 classification
```
Execute:
- Validate path with FileSystemValidator
- Create parent directories if needed
- Call backup_before_modify() if file exists
- Write content
- Call cleanup_old_backups() after successful write
- Return {path, size, backup_path}

**3. FileDeleteTool:**
```python
name = "file_delete"
description = "Delete a file. Creates backup before deletion."
parameters_schema = {
    "type": "object",
    "properties": {
        "path": {"type": "string", "description": "Absolute path to file"}
    },
    "required": ["path"]
}
is_destructive = True
```
Execute:
- Validate path with FileSystemValidator
- Call backup_before_modify() - this preserves the file before deletion
- Delete the file
- Return {deleted_path, backup_path}

**4. FileListTool:**
```python
name = "file_list"
description = "List files in a directory. Respects allowed directories."
parameters_schema = {
    "type": "object",
    "properties": {
        "path": {"type": "string", "description": "Absolute path to directory"},
        "pattern": {"type": "string", "description": "Glob pattern (default: *)", "default": "*"},
        "recursive": {"type": "boolean", "default": False}
    },
    "required": ["path"]
}
```
Execute:
- Validate directory path with FileSystemValidator
- List files matching pattern (use Path.glob or Path.rglob)
- Return list of {name, path, size, is_dir, modified} dicts

Use aiofiles for async file I/O where possible. Fall back to asyncio.to_thread() for operations aiofiles doesn't support.
  </action>
  <verify>
```python
import asyncio
import tempfile
from pathlib import Path
from src.agent.tools.filesystem import FileReadTool, FileWriteTool, FileDeleteTool, FileListTool
from src.agent.registry.base_tool import AgentContext

ctx = AgentContext(session_id="test")

# Test write
with tempfile.TemporaryDirectory() as tmpdir:
    test_file = Path(tmpdir) / "test.txt"
    write_tool = FileWriteTool()
    result = asyncio.run(write_tool.execute({"path": str(test_file), "content": "hello"}, ctx))
    assert result.success, f"Write failed: {result.error}"

    # Test read
    read_tool = FileReadTool()
    result = asyncio.run(read_tool.execute({"path": str(test_file)}, ctx))
    assert result.success and result.data["content"] == "hello"

    # Test list
    list_tool = FileListTool()
    result = asyncio.run(list_tool.execute({"path": tmpdir}, ctx))
    assert result.success and len(result.data) == 1

print("All filesystem tools work!")
```
  </verify>
  <done>All four filesystem tools validate paths, create backups, and handle files correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Register filesystem tools in ToolRegistry</name>
  <files>
    src/agent/tools/__init__.py
    src/agent/registry/tool_registry.py
  </files>
  <action>
1. Update `src/agent/tools/__init__.py`:
```python
from src.agent.tools.base import FileSystemValidator, backup_before_modify, cleanup_old_backups
from src.agent.tools.web_search import WebSearchTool
from src.agent.tools.filesystem import FileReadTool, FileWriteTool, FileDeleteTool, FileListTool

__all__ = [
    # Base utilities
    "FileSystemValidator",
    "backup_before_modify",
    "cleanup_old_backups",
    # Tools
    "WebSearchTool",
    "FileReadTool",
    "FileWriteTool",
    "FileDeleteTool",
    "FileListTool",
]
```

2. Update `_load_builtin_tools()` in ToolRegistry:
```python
def _load_builtin_tools(self) -> None:
    """Load built-in tools."""
    # Testing tool
    from src.agent.registry.mock_tool import MockTool
    self.register(MockTool)

    # Built-in tools
    from src.agent.tools import (
        WebSearchTool,
        FileReadTool,
        FileWriteTool,
        FileDeleteTool,
        FileListTool,
    )
    self.register(WebSearchTool)
    self.register(FileReadTool)
    self.register(FileWriteTool)
    self.register(FileDeleteTool)
    self.register(FileListTool)

    logger.info(f"Loaded {len(self._tools)} built-in tools")
```
  </action>
  <verify>
```python
from src.agent.registry import get_tool_registry
registry = get_tool_registry()
for name in ['file_read', 'file_write', 'file_delete', 'file_list']:
    assert name in registry.tool_names, f"Missing: {name}"
print(f"Filesystem tools registered: {[n for n in registry.tool_names if 'file' in n]}")
```
  </verify>
  <done>All filesystem tools registered in ToolRegistry.</done>
</task>

</tasks>

<verification>
1. All four filesystem tools execute successfully
2. Blocked patterns prevent access (test with .env file path)
3. Backup files created on write/delete operations
4. Old backups cleaned up automatically
5. All tools registered in ToolRegistry

```bash
python -c "
import asyncio
import tempfile
from pathlib import Path
from src.agent.registry import get_tool_registry
from src.agent.registry.base_tool import AgentContext

registry = get_tool_registry()
ctx = AgentContext(session_id='test')

# Test validation rejects .env
tool = registry.get_tool('file_read')
result = asyncio.run(tool.execute({'path': '/home/user/.env'}, ctx))
assert not result.success, '.env should be blocked'

print('Security validation working')
print(f'Filesystem tools: {[n for n in registry.tool_names if \"file\" in n]}')
"
```
</verification>

<success_criteria>
- [ ] FileReadTool reads files within allowed directories
- [ ] FileWriteTool creates backups before overwriting
- [ ] FileDeleteTool creates backup before deletion
- [ ] FileListTool lists directory contents with metadata
- [ ] Blocked patterns (.env, credentials, etc.) are rejected
- [ ] Paths outside allowed directories are rejected
- [ ] All tools marked as destructive where appropriate (write, delete)
- [ ] All tools registered in ToolRegistry
</success_criteria>

<output>
After completion, create `.planning/phases/10-built-in-tools/10-03-SUMMARY.md`
</output>
