---
phase: 10-built-in-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/agent/tools/__init__.py
  - src/agent/tools/base.py
  - src/agent/registry/tool_registry.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Tool foundation utilities exist for path validation and backup"
    - "Built-in tools can be registered via ToolRegistry._load_builtin_tools()"
    - "New dependencies are declared in requirements.txt"
  artifacts:
    - path: "src/agent/tools/__init__.py"
      provides: "Tools package exports"
      min_lines: 5
    - path: "src/agent/tools/base.py"
      provides: "FileSystemValidator, backup_before_modify, cleanup_old_backups"
      exports: ["FileSystemValidator", "backup_before_modify", "cleanup_old_backups"]
    - path: "src/agent/registry/tool_registry.py"
      provides: "Updated _load_builtin_tools with placeholder for built-in tools"
      contains: "_load_builtin_tools"
  key_links:
    - from: "src/agent/tools/base.py"
      to: "pathlib.Path"
      via: "Path.resolve() and is_relative_to()"
      pattern: "is_relative_to"
    - from: "src/agent/registry/tool_registry.py"
      to: "src/agent/tools"
      via: "import from tools package"
      pattern: "from src.agent.tools"
---

<objective>
Establish the foundation for built-in tools: shared utilities for path validation and file backup, plus registration infrastructure.

Purpose: All filesystem-touching tools need consistent path validation (security) and backup (safety). This plan creates shared utilities that Plans 03-06 will use.

Output: `src/agent/tools/` package with base utilities, updated ToolRegistry for built-in tool loading.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-built-in-tools/10-CONTEXT.md
@.planning/phases/10-built-in-tools/10-RESEARCH.md

# Existing patterns to follow
@src/agent/registry/base_tool.py
@src/agent/registry/tool_registry.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tools package with base utilities</name>
  <files>
    src/agent/tools/__init__.py
    src/agent/tools/base.py
  </files>
  <action>
Create `src/agent/tools/` directory structure.

In `src/agent/tools/base.py`, implement:

1. **FileSystemValidator class:**
   - `__init__(allowed_paths: list[str], blocked_patterns: list[str])` - stores resolved allowed paths and blocked patterns (e.g., [".env", "credentials", ".git"])
   - `validate(path_str: str) -> tuple[bool, str]` - returns (is_valid, error_message)
   - Use `Path(path_str).resolve()` to handle symlinks and relative paths
   - Check blocked patterns against full path string
   - Use `is_relative_to()` to check if path is within allowed directories
   - Return descriptive error messages: "Path contains blocked pattern: X" or "Path not in allowed directories"

2. **backup_before_modify(path: Path) -> Path | None function:**
   - If path doesn't exist, return None
   - Create timestamped backup: `original.20260121_143052.bak`
   - Use `shutil.copy2()` to preserve metadata
   - Return the backup path

3. **cleanup_old_backups(original_path: Path, keep: int = 5) function:**
   - Find all backups matching `{stem}.*.bak` pattern
   - Sort by modification time descending
   - Remove all but the most recent `keep` backups
   - Handle PermissionError gracefully (log warning, continue)

In `src/agent/tools/__init__.py`:
- Export: FileSystemValidator, backup_before_modify, cleanup_old_backups
  </action>
  <verify>
```python
from src.agent.tools import FileSystemValidator, backup_before_modify, cleanup_old_backups
validator = FileSystemValidator(["/tmp"], [".env", ".git"])
assert validator.validate("/tmp/test.txt") == (True, "")
assert validator.validate("/etc/passwd")[0] == False
assert validator.validate("/tmp/.env")[0] == False
```
  </verify>
  <done>FileSystemValidator validates paths against allowlist and blocked patterns. Backup utilities create and clean up timestamped backups.</done>
</task>

<task type="auto">
  <name>Task 2: Update ToolRegistry for built-in tool loading</name>
  <files>
    src/agent/registry/tool_registry.py
  </files>
  <action>
Modify `_load_builtin_tools()` in ToolRegistry to prepare for built-in tools:

1. Keep the existing MockTool registration for testing

2. Add a section for built-in tools with a comment indicating where tools will be added:
```python
def _load_builtin_tools(self) -> None:
    """Load built-in tools. Extended in later phases."""
    # Testing tool
    from src.agent.registry.mock_tool import MockTool
    self.register(MockTool)

    # Built-in tools - loaded here as they're developed
    # Web search, filesystem, code execution, browser, GitHub tools
    # will be registered in this method as Plans 02-05 complete

    logger.info(f"Loaded {len(self._tools)} built-in tools")
```

This is a minimal change - subsequent plans will add actual tool registrations.
  </action>
  <verify>
```python
from src.agent.registry import get_tool_registry
registry = get_tool_registry()
assert 'mock_echo' in registry.tool_names
```
  </verify>
  <done>ToolRegistry._load_builtin_tools() is prepared for built-in tool registration.</done>
</task>

<task type="auto">
  <name>Task 3: Add dependencies to requirements.txt</name>
  <files>
    requirements.txt
  </files>
  <action>
Add the following dependencies for Phase 10 tools:

```
# Agent Tools (Phase 10)
duckduckgo-search>=8.0.0       # Web search API (no key required)
playwright>=1.49.0              # Browser automation
playwright-stealth>=1.0.0       # Bot detection evasion
PyGithub>=2.8.0                 # GitHub API client
psutil>=7.0.0                   # Process/resource monitoring
beautifulsoup4>=4.12.0          # HTML parsing for search fallback
tenacity>=8.0.0                 # Retry logic (may already exist)
```

Note: `aiofiles` is already in requirements.txt (>=23.0.0), `httpx` is already present (>=0.27.0).

Add these after the existing "Utilities" section, before "Cloud Services".

Also add a comment noting that `playwright install chromium` must be run after pip install to get browser binaries.
  </action>
  <verify>
```bash
grep -E "duckduckgo-search|playwright|PyGithub|psutil|beautifulsoup4" requirements.txt
```
  </verify>
  <done>All Phase 10 dependencies are declared in requirements.txt with version constraints.</done>
</task>

</tasks>

<verification>
1. `src/agent/tools/` package exists with `__init__.py` and `base.py`
2. FileSystemValidator correctly validates paths against allowlist and blocked patterns
3. Backup functions create timestamped backups and clean up old ones
4. ToolRegistry imports successfully and loads mock tool
5. All new dependencies appear in requirements.txt

```bash
python -c "from src.agent.tools import FileSystemValidator, backup_before_modify, cleanup_old_backups; print('Imports OK')"
python -c "from src.agent.registry import get_tool_registry; r = get_tool_registry(); print(f'Tools: {r.tool_names}')"
```
</verification>

<success_criteria>
- [ ] FileSystemValidator validates paths correctly (allows valid, blocks dangerous)
- [ ] backup_before_modify creates timestamped .bak files
- [ ] cleanup_old_backups removes old backups, keeps N most recent
- [ ] ToolRegistry loads without errors
- [ ] requirements.txt includes duckduckgo-search, playwright, playwright-stealth, PyGithub, psutil, beautifulsoup4
</success_criteria>

<output>
After completion, create `.planning/phases/10-built-in-tools/10-01-SUMMARY.md`
</output>
