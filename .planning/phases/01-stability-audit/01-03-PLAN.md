---
phase: 01-stability-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/views/workflow_editor.py
  - src/ui/views/workflows.py
  - src/core/workflow/executor.py
  - src/core/workflow/models.py
  - tests/unit/test_workflow_audit.py
autonomous: true

must_haves:
  truths:
    - "User can create a new workflow"
    - "User can add nodes to a workflow and connect them"
    - "User can save a workflow and see it persisted"
    - "User can execute a workflow without crashes"
    - "User can delete a workflow"
  artifacts:
    - path: "tests/unit/test_workflow_audit.py"
      provides: "Regression tests for Workflow Builder bugs found during audit"
      min_lines: 50
  key_links:
    - from: "src/ui/views/workflow_editor.py"
      to: "src/core/workflow/executor.py"
      via: "WorkflowExecutor.execute()"
      pattern: "executor\\.execute"
    - from: "src/ui/views/workflows.py"
      to: "src/data/storage.py"
      via: "Storage save/load operations"
      pattern: "storage\\.(save|load|delete)_workflow"
---

<objective>
Audit Workflow Builder functionality to identify and fix all bugs.

Purpose: Ensure the Workflow Builder (create, edit, save, execute workflows) works reliably. This is a core feature enabling automation.
Output: Bug-free Workflow Builder with regression tests capturing all fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-stability-audit/01-RESEARCH.md
@.planning/phases/01-stability-audit/01-CONTEXT.md

# Source files to audit
@src/ui/views/workflow_editor.py
@src/ui/views/workflows.py
@src/ui/views/simple_mode.py (used by workflow_editor)
@src/core/workflow/executor.py
@src/core/workflow/models.py
@tests/fixtures/workflows.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Static analysis and manual audit of Workflow Builder</name>
  <files>
    - src/ui/views/workflow_editor.py (342 lines)
    - src/ui/views/workflows.py
    - src/core/workflow/executor.py
    - src/core/workflow/models.py
  </files>
  <action>
Run static analysis first:
```bash
ruff check src/ui/views/workflow_editor.py src/ui/views/workflows.py src/core/workflow/
mypy src/ui/views/workflow_editor.py src/ui/views/workflows.py src/core/workflow/
```

Perform manual code audit:

1. **Workflow List View** (workflows.py):
   - Check workflow list loading
   - Check create/delete operations
   - Check navigation to editor

2. **Workflow Editor** (workflow_editor.py):
   - Check simple mode vs advanced mode toggle
   - Check workflow name editing
   - Check save functionality (on_save callback chain)
   - Check back navigation (on_back callback)

3. **Simple Mode** (simple_mode.py - workflow steps):
   - Check step add/remove/reorder
   - Check step configuration
   - Check trigger handling
   - Check node connections generated correctly

4. **Workflow Execution** (executor.py):
   - Check execution flow (node ordering)
   - Check error handling during execution
   - Check async execution patterns
   - Check execution context passing between nodes

5. **Data Models** (models.py):
   - Check Workflow, WorkflowNode, WorkflowConnection models
   - Check serialization/deserialization
   - Check validation

Document findings with format:
```python
# AUDIT-BUG: [description]
# AUDIT-FIX: [proposed fix]
```

Run existing tests:
```bash
pytest tests/unit/test_workflow_*.py tests/e2e/test_workflow*.py tests/integration/test_ui_workflows.py -v --tb=short
```
  </action>
  <verify>
- `ruff check` and `mypy` complete (note any errors)
- All 5 areas audited and documented
- At least 3 bug findings documented (or explicit "no bugs found" note)
- Existing test results recorded
  </verify>
  <done>
Audit complete with documented findings. Ready to fix bugs and write regression tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix bugs and write regression tests</name>
  <files>
    - src/ui/views/workflow_editor.py
    - src/ui/views/workflows.py
    - src/core/workflow/executor.py
    - src/core/workflow/models.py
    - tests/unit/test_workflow_audit.py (create)
  </files>
  <action>
For each bug found in Task 1:

1. Write a failing test first:
```python
# tests/unit/test_workflow_audit.py
import pytest
from src.core.workflow.models import Workflow, WorkflowNode, WorkflowConnection
from tests.fixtures.workflows import sample_workflow_data

class TestWorkflowAuditFindings:
    """Regression tests for bugs found during Workflow Builder audit."""

    @pytest.fixture
    def sample_workflow(self, sample_workflow_data):
        return Workflow.from_dict(sample_workflow_data)

    @pytest.mark.xfail(reason="BUG: [description]")
    def test_[bug_description](self, sample_workflow):
        pass
```

2. Fix the bug in the source file

3. Remove xfail marker, verify test passes

4. Run the test:
```bash
pytest tests/unit/test_workflow_audit.py -v
```

Use existing fixtures from tests/fixtures/workflows.py (sample_workflow_data, multiple_workflows_data) and conftest.py.

Testing patterns:
- Test models directly (pure Python, no Flet)
- Test executor with mock nodes
- Mock page for UI tests
- Use pytest-asyncio for async executor tests

If no bugs found, create characterization tests documenting correct behavior.
  </action>
  <verify>
- `pytest tests/unit/test_workflow_audit.py -v` passes
- All bugs have corresponding regression tests
- No `@pytest.mark.xfail` markers remain
- Run full test suite: `pytest tests/ -v --tb=short` - no new failures
  </verify>
  <done>
All Workflow Builder bugs fixed. Each fix has a regression test. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
```bash
# Static analysis clean
ruff check src/ui/views/workflow_editor.py src/ui/views/workflows.py src/core/workflow/
mypy src/ui/views/workflow_editor.py src/ui/views/workflows.py src/core/workflow/

# All tests pass
pytest tests/unit/test_workflow_audit.py -v
pytest tests/ -v --tb=short
```
</verification>

<success_criteria>
- Workflow Builder code audited with static analysis and manual review
- All discovered bugs fixed
- Each bug fix has a regression test
- No existing tests broken
- STAB-03 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-stability-audit/01-03-SUMMARY.md`
</output>
