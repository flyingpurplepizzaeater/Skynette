---
phase: 06-rag-context-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/views/code_editor/__init__.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ChatPanel receives RAGContextProvider instance"
    - "AI chat queries include codebase context from RAG when project folder is open"
    - "RAGContextProvider is disposed when CodeEditorView closes"
  artifacts:
    - path: "src/ui/views/code_editor/__init__.py"
      provides: "RAGContextProvider wiring to ChatPanel"
      contains: "RAGContextProvider"
  key_links:
    - from: "CodeEditorView"
      to: "RAGContextProvider"
      via: "self._rag_provider instantiation"
      pattern: "_rag_provider.*=.*RAGContextProvider"
    - from: "CodeEditorView"
      to: "ChatPanel"
      via: "rag_provider parameter"
      pattern: "ChatPanel.*rag_provider.*=.*self._rag_provider"
    - from: "CodeEditorView.dispose()"
      to: "RAGContextProvider/EmbeddingManager"
      via: "shutdown calls"
      pattern: "_embedding_manager\\.shutdown"
---

<objective>
Wire RAGContextProvider to ChatPanel in CodeEditorView so AI chat queries include relevant codebase context.

Purpose: Complete the RAG integration (INTG-02) by connecting the existing RAGContextProvider to ChatPanel. Currently, RAGContextProvider exists but is not instantiated or passed to ChatPanel.

Output: Updated CodeEditorView that:
1. Creates ChromaDBClient and EmbeddingManager instances
2. Creates RAGContextProvider with those instances
3. Passes rag_provider and get_project_root to ChatPanel
4. Properly disposes RAG components on view close
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v2-MILESTONE-AUDIT.md

# Key files to understand
@src/ui/views/code_editor/__init__.py
@src/ui/views/code_editor/ai_panel/rag_context.py
@src/ui/views/code_editor/ai_panel/chat_panel.py
@src/rag/chromadb_client.py
@src/rag/embeddings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire RAGContextProvider to ChatPanel</name>
  <files>src/ui/views/code_editor/__init__.py</files>
  <action>
Update CodeEditorView to instantiate and wire RAGContextProvider:

1. Add imports at top of file:
   ```python
   from src.rag.chromadb_client import ChromaDBClient
   from src.rag.embeddings import EmbeddingManager
   from src.ui.views.code_editor.ai_panel.rag_context import RAGContextProvider
   ```

2. In __init__, add RAG component references (after line 96, with other state):
   ```python
   # RAG context for AI chat
   self._chromadb_client: ChromaDBClient | None = None
   self._embedding_manager: EmbeddingManager | None = None
   self._rag_provider: RAGContextProvider | None = None
   ```

3. In build(), BEFORE creating ChatPanel (before line 158):
   - Create ChromaDBClient with a temp directory for project-specific storage
   - Create EmbeddingManager
   - Create RAGContextProvider with both

   ```python
   # Initialize RAG components for AI chat context
   import tempfile
   import os
   rag_persist_dir = os.path.join(tempfile.gettempdir(), "skynette_rag")
   self._chromadb_client = ChromaDBClient(rag_persist_dir)
   self._embedding_manager = EmbeddingManager()
   self._rag_provider = RAGContextProvider(
       chromadb_client=self._chromadb_client,
       embedding_manager=self._embedding_manager,
   )
   ```

4. Update ChatPanel instantiation (lines 158-164) to pass rag_provider and get_project_root:
   ```python
   self._chat_panel = ChatPanel(
       page=self._page_ref,
       state=self.chat_state,
       gateway=self._gateway,
       on_include_code=self._get_selected_code,
       on_code_suggestion=self.show_diff_from_ai,
       rag_provider=self._rag_provider,
       get_project_root=lambda: self.state.file_tree_root,
   )
   ```

5. In dispose() method, add cleanup for RAG components (after line 817, before disposing chat_panel):
   ```python
   # Dispose RAG components
   if self._embedding_manager:
       self._embedding_manager.shutdown()
   # ChromaDBClient and RAGContextProvider don't need explicit shutdown
   self._rag_provider = None
   self._chromadb_client = None
   self._embedding_manager = None
   ```
  </action>
  <verify>
Run: `python -c "from src.ui.views.code_editor import CodeEditorView; print('Import OK')"`

Verify the file contains:
- `from src.rag.chromadb_client import ChromaDBClient`
- `from src.rag.embeddings import EmbeddingManager`
- `from src.ui.views.code_editor.ai_panel.rag_context import RAGContextProvider`
- `self._rag_provider = RAGContextProvider(`
- `rag_provider=self._rag_provider`
- `get_project_root=lambda: self.state.file_tree_root`
- `self._embedding_manager.shutdown()`
  </verify>
  <done>
ChatPanel receives RAGContextProvider instance with ChromaDBClient and EmbeddingManager.
RAGContextProvider is properly disposed when CodeEditorView closes.
AI chat can now retrieve codebase context when a project folder is open.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test for RAG wiring</name>
  <files>tests/test_rag_wiring.py</files>
  <action>
Create a new test file to verify the RAG wiring:

```python
# tests/test_rag_wiring.py
"""Tests for RAG wiring in CodeEditorView."""

import pytest
from unittest.mock import MagicMock, patch


class TestRAGWiring:
    """Test RAG provider wiring to ChatPanel."""

    def test_code_editor_view_has_rag_components(self):
        """Verify CodeEditorView initializes RAG component references."""
        # Import after patching to avoid Flet initialization
        with patch('flet.Page'):
            with patch('flet.Column.__init__', return_value=None):
                with patch('flet.FilePicker'):
                    from src.ui.views.code_editor import CodeEditorView

                    # Check class has RAG attributes
                    assert hasattr(CodeEditorView, '__init__')

                    # Read the source to verify imports exist
                    import inspect
                    source = inspect.getsource(CodeEditorView)

                    assert 'RAGContextProvider' in source
                    assert '_rag_provider' in source
                    assert '_chromadb_client' in source
                    assert '_embedding_manager' in source

    def test_chat_panel_receives_rag_provider_parameter(self):
        """Verify ChatPanel is instantiated with rag_provider."""
        import inspect
        from src.ui.views.code_editor import CodeEditorView

        source = inspect.getsource(CodeEditorView)

        # Check ChatPanel instantiation includes rag_provider
        assert 'rag_provider=self._rag_provider' in source
        assert 'get_project_root=' in source

    def test_dispose_shuts_down_embedding_manager(self):
        """Verify dispose() cleans up RAG components."""
        import inspect
        from src.ui.views.code_editor import CodeEditorView

        source = inspect.getsource(CodeEditorView.dispose)

        # Check dispose includes embedding manager shutdown
        assert '_embedding_manager' in source
        assert 'shutdown' in source


class TestRAGContextProvider:
    """Test RAGContextProvider functionality."""

    @pytest.mark.asyncio
    async def test_get_context_returns_empty_without_project(self):
        """Verify get_context returns empty when no project root."""
        from src.rag.chromadb_client import ChromaDBClient
        from src.rag.embeddings import EmbeddingManager
        from src.ui.views.code_editor.ai_panel.rag_context import RAGContextProvider

        # Mock dependencies
        mock_chromadb = MagicMock(spec=ChromaDBClient)
        mock_embedding = MagicMock(spec=EmbeddingManager)

        provider = RAGContextProvider(mock_chromadb, mock_embedding)

        # Should return empty when project_root is None
        context, sources = await provider.get_context("test query", None)

        assert context == ""
        assert sources == []

    def test_rag_context_provider_imports(self):
        """Verify RAGContextProvider can be imported from ai_panel."""
        from src.ui.views.code_editor.ai_panel.rag_context import RAGContextProvider

        assert RAGContextProvider is not None
        assert hasattr(RAGContextProvider, 'get_context')
        assert hasattr(RAGContextProvider, 'ensure_indexed')
```
  </action>
  <verify>
Run: `python -m pytest tests/test_rag_wiring.py -v`

All 5 tests should pass:
- test_code_editor_view_has_rag_components
- test_chat_panel_receives_rag_provider_parameter
- test_dispose_shuts_down_embedding_manager
- test_get_context_returns_empty_without_project
- test_rag_context_provider_imports
  </verify>
  <done>
Tests confirm RAGContextProvider is properly wired to ChatPanel and disposed correctly.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Import verification:
   ```bash
   python -c "from src.ui.views.code_editor import CodeEditorView; print('Import OK')"
   ```

2. Run new tests:
   ```bash
   python -m pytest tests/test_rag_wiring.py -v
   ```

3. Run existing Phase 5 tests to ensure no regressions:
   ```bash
   python -m pytest tests/test_rag_context.py -v
   ```

4. Verify audit gap is closed by checking code contains required patterns:
   ```bash
   grep -n "rag_provider=self._rag_provider" src/ui/views/code_editor/__init__.py
   grep -n "get_project_root=lambda" src/ui/views/code_editor/__init__.py
   grep -n "_embedding_manager.shutdown" src/ui/views/code_editor/__init__.py
   ```
</verification>

<success_criteria>
1. CodeEditorView imports RAGContextProvider, ChromaDBClient, EmbeddingManager
2. CodeEditorView creates RAGContextProvider with proper dependencies
3. ChatPanel instantiation includes rag_provider=self._rag_provider
4. ChatPanel instantiation includes get_project_root callback
5. dispose() method calls _embedding_manager.shutdown()
6. All tests pass (new and existing)
7. No import errors when loading CodeEditorView
</success_criteria>

<output>
After completion, create `.planning/phases/06-rag-context-wiring/06-01-SUMMARY.md`
</output>
